<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>httprouter - The Coding Dead</title><link rel="icon" href="/favicon.ico"/><meta name="description" content="Goの有名パッケージhttprouterを読みます。"/><meta property="og:image" content="https://raw.githubusercontent.com/the-coding-dead/the-coding-dead.github.io/main/public/images/og-image.png"/><meta name="og:title" content="httprouter - The Coding Dead"/><meta name="og:description" content="Goの有名パッケージhttprouterを読みます。"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/b9772c72096ad1651865.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b9772c72096ad1651865.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-e13f5e753692f9663f23.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.73361561705e18283b5e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-a1b5a40e975a4b990753.js" as="script"/></head><body><div id="__next"><div class="bg-gray-800 h-auto w-screen p-3"><div class="cursor-pointer hover:opacity-75"><div><p class="text-3xl font-bold mb-2">The Coding Dead</p><p class="text-xs">窒息するほどコードを読んで<br/>スーパーエンジニアになった気になる</p></div></div></div><div class="container mx-auto"><div class="container h-screen flex flex-col"><div class="container px-2 flex-grow "><main><article class="relative container mt-5 p-3 bg-gray-600 rounded"><div class="absolute top-2 right-2 bg-gray-700 h-4 w-4 rounded-full"></div><h1 class="text-3xl mb-1">httprouter</h1><div class="text-sm"><p>Related articles</p><ol><li><a href="httprouter">この記事</a></li><li><a href="httprouter2">httprouter2</a></li><li><a href="httprouter3">httprouter3</a></li></ol></div><time dateTime="2021-01-17">January 17, 2021</time><pre class="my-0 p-0" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e;padding:1em;margin:.5em 0;overflow:auto"><code class="language-go" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e"><span class="token" style="color:#47ebb4">func</span><span> </span><span class="token" style="color:#57718e">main</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span>
</span><span>	router </span><span class="token" style="color:#0aa370">:=</span><span> httprouter</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">New</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span>	router</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">GET</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;/&quot;</span><span class="token" style="color:#4a5f78">,</span><span> Index</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span>	router</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">GET</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;/hello/:name&quot;</span><span class="token" style="color:#4a5f78">,</span><span> Hello</span><span class="token" style="color:#4a5f78">)</span><span>
</span>
<span>	log</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">Fatal</span><span class="token" style="color:#4a5f78">(</span><span>http</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">ListenAndServe</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;:8080&quot;</span><span class="token" style="color:#4a5f78">,</span><span> router</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span></span><span class="token" style="color:#4a5f78">}</span><span>
</span>
</code></pre><div><p>今日は<a href="https://github.com/julienschmidt/httprouter">julienschmidt/httprouter</a>です。</p>
<p>たまに雑な API を Go で作るときに使うのでどのように実装されているか気になってました。</p>
<p>見てみます。</p>
<h1>Repository</h1>
<p><a href="https://github.com/julienschmidt/httprouter">github.com/julienschmidt/httprouter</a></p>
<h1>Package Features - Named parameters</h1>
<p><a href="https://github.com/julienschmidt/httprouter">httprouter</a>の一番の<code>net/http</code>との違いは<code>Named parameters</code>だと思います。</p>
<p><code>router.GET("/hello/:name", Hello)</code>と登録することで</p>
<p><code>httprouter.Params.ByName("name")</code>でパラメータを取得できます。</p>
<p>まだいっぱい特徴があるのですが、今回はこの機能に絞ってコードを読んでいきます。</p>
<h2>router.go</h2>
<p>コード: <a href="https://github.com/julienschmidt/httprouter/blob/master/router.go">router.go</a></p>
<h1>Reading</h1>
<p>まず、必ず呼び出すコンストラクタです。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// New returns a new initialized Router.</span>
<span class="token comment">// Path auto-correction, including trailing slashes, is enabled by default.</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Router <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&#x26;</span>Router<span class="token punctuation">{</span>
		RedirectTrailingSlash<span class="token punctuation">:</span>  <span class="token boolean">true</span><span class="token punctuation">,</span>
		RedirectFixedPath<span class="token punctuation">:</span>      <span class="token boolean">true</span><span class="token punctuation">,</span>
		HandleMethodNotAllowed<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		HandleOPTIONS<span class="token punctuation">:</span>          <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>返却される<code>*Router</code>は<code>net/http.Handler</code>インターフェイスを実装しています。</p>
<p>下記のコードでわかります。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Make sure the Router conforms with the http.Handler interface</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> http<span class="token punctuation">.</span>Handler <span class="token operator">=</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div>
<p><code>net/http</code>の方も読んでみたくなるなあ。また今度にします。</p>
<p>次に実際にパスに登録するための<code>GET</code>や<code>POST</code>メソッドです。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello/:name"</span><span class="token punctuation">,</span> Hello<span class="token punctuation">)</span>
</code></pre></div>
<p>のように使います。</p>
<p>これは下記のコードです。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// GET is a shortcut for router.Handle(http.MethodGet, path, handle)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">GET</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// HEAD is a shortcut for router.Handle(http.MethodHead, path, handle)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">HEAD</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodHead<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// OPTIONS is a shortcut for router.Handle(http.MethodOptions, path, handle)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">OPTIONS</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodOptions<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// POST is a shortcut for router.Handle(http.MethodPost, path, handle)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">POST</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPost<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// PUT is a shortcut for router.Handle(http.MethodPut, path, handle)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">PUT</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPut<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// PATCH is a shortcut for router.Handle(http.MethodPatch, path, handle)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">PATCH</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPatch<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// DELETE is a shortcut for router.Handle(http.MethodDelete, path, handle)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">DELETE</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodDelete<span class="token punctuation">,</span> path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p><code>*Router.Handle</code>をラップしているだけです。</p>
<p><code>*Router.Handle</code>に HTTP メソッド、パス、<code>Handle</code>型を渡します。</p>
<p><code>Handle</code>型は</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> Handle <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> Params<span class="token punctuation">)</span>
</code></pre></div>
<p>と定義されています。</p>
<p><code>net/http</code>の<code>HandlerFunc</code>型を拡張した型のようです。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> HandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>Request<span class="token punctuation">)</span>
</code></pre></div>
<p><code>Handle</code>型の第三引数<code>Param</code>は下記です。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Param is a single URL parameter, consisting of a key and a value.</span>
<span class="token keyword">type</span> Param <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Key   <span class="token builtin">string</span>
	Value <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// Params is a Param-slice, as returned by the router.</span>
<span class="token comment">// The slice is ordered, the first URL parameter is also the first slice value.</span>
<span class="token comment">// It is therefore safe to read values by the index.</span>
<span class="token keyword">type</span> Params <span class="token punctuation">[</span><span class="token punctuation">]</span>Param
</code></pre></div>
<p>単純にパラメータを格納しておくもののようです。</p>
<p>お目当てのパラメータは<code>Params.ByName</code>メソッドで取得できます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// ByName returns the value of the first Param which key matches the given name.</span>
<span class="token comment">// If no matching Param is found, an empty string is returned.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>ps Params<span class="token punctuation">)</span> <span class="token function">ByName</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> ps <span class="token punctuation">{</span>
		<span class="token keyword">if</span> p<span class="token punctuation">.</span>Key <span class="token operator">==</span> name <span class="token punctuation">{</span>
			<span class="token keyword">return</span> p<span class="token punctuation">.</span>Value
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token string">""</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>なぜ<code>type Param map[string]string</code>で実装しないのでしょうか?</p>
<p>理由がありそうなので<code>*Router.Handle</code>で実際にどのようにパスと<code>Handle</code>型を紐付けているのか見てみます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Handle registers a new request handle with the given path and method.</span>
<span class="token comment">//</span>
<span class="token comment">// For GET, POST, PUT, PATCH and DELETE requests the respective shortcut</span>
<span class="token comment">// functions can be used.</span>
<span class="token comment">//</span>
<span class="token comment">// This function is intended for bulk loading and to allow the usage of less</span>
<span class="token comment">// frequently used, non-standardized or custom methods (e.g. for internal</span>
<span class="token comment">// communication with a proxy).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	varsCount <span class="token operator">:=</span> <span class="token function">uint16</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

	<span class="token comment">// 1</span>
	<span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"method must not be empty"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">1</span> <span class="token operator">||</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"path must begin with '/' in path '"</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> handle <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"handle must not be nil"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 2</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>SaveMatchedRoutePath <span class="token punctuation">{</span>
		varsCount<span class="token operator">++</span>
		handle <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">saveMatchedRoutePath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 3</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>trees <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>trees <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 4</span>
	root <span class="token operator">:=</span> r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
	<span class="token keyword">if</span> root <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		root <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
		r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> root

		r<span class="token punctuation">.</span>globalAllowed <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">allowed</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 5</span>
	root<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>

	<span class="token comment">// Update maxParams</span>
	<span class="token keyword">if</span> paramsCount <span class="token operator">:=</span> <span class="token function">countParams</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> paramsCount<span class="token operator">+</span>varsCount <span class="token operator">></span> r<span class="token punctuation">.</span>maxParams <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>maxParams <span class="token operator">=</span> paramsCount <span class="token operator">+</span> varsCount
	<span class="token punctuation">}</span>

	<span class="token comment">// Lazy-init paramsPool alloc func</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>paramsPool<span class="token punctuation">.</span>New <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&#x26;&#x26;</span> r<span class="token punctuation">.</span>maxParams <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>paramsPool<span class="token punctuation">.</span>New <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
			ps <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>Params<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>maxParams<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">&#x26;</span>ps
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ol>
<li>バリデーション</li>
</ol>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">if</span> method <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"method must not be empty"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">1</span> <span class="token operator">||</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"path must begin with '/' in path '"</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> handle <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"handle must not be nil"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ol start="2">
<li><code>*Router.SaveMatchedRoutePath = true</code>を設定している場合のみ実行されます。</li>
</ol>
<p><code>Handle</code>型の実行の直前に<code>Params</code>にパスを追加します。</p>
<p>便利やー</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">saveMatchedRoutePath</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> Handle <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> ps Params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> ps <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			psp <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			ps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>psp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span>
			<span class="token comment">// ここ</span>
			ps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Param<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> MatchedRoutePathParam<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> path<span class="token punctuation">}</span>
			<span class="token function">handle</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> ps<span class="token punctuation">)</span>
			r<span class="token punctuation">.</span><span class="token function">putParams</span><span class="token punctuation">(</span>psp<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			ps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ps<span class="token punctuation">,</span> Param<span class="token punctuation">{</span>Key<span class="token punctuation">:</span> MatchedRoutePathParam<span class="token punctuation">,</span> Value<span class="token punctuation">:</span> path<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token function">handle</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> ps<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">if</span> r<span class="token punctuation">.</span>SaveMatchedRoutePath <span class="token punctuation">{</span>
	varsCount<span class="token operator">++</span>
	handle <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">saveMatchedRoutePath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ol start="3">
<li><code>*Router</code>に対して<code>Handle</code>が最初に呼び出された場合は初期化します。</li>
</ol>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">if</span> r<span class="token punctuation">.</span>trees <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>trees <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>ここで<code>*Router</code>を見てみることにします。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Router is a http.Handler which can be used to dispatch requests to different</span>
<span class="token comment">// handler functions via configurable routes</span>
<span class="token keyword">type</span> Router <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	trees <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node

	<span class="token comment">// comments...</span>
	RedirectTrailingSlash <span class="token builtin">bool</span>

	<span class="token comment">// comments...</span>
	RedirectFixedPath <span class="token builtin">bool</span>

	<span class="token comment">// comments...</span>
	HandleMethodNotAllowed <span class="token builtin">bool</span>

	<span class="token comment">// comments...</span>
	HandleOPTIONS <span class="token builtin">bool</span>

	<span class="token comment">// comments...</span>
	GlobalOPTIONS http<span class="token punctuation">.</span>Handler

	<span class="token comment">// comments...</span>
	globalAllowed <span class="token builtin">string</span>

	<span class="token comment">// comments...</span>
	NotFound http<span class="token punctuation">.</span>Handler

	<span class="token comment">// comments...</span>
	MethodNotAllowed http<span class="token punctuation">.</span>Handler

	<span class="token comment">// comments...</span>
	PanicHandler <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>ここで着目したいのは<code>trees</code>フィールドです。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">trees <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>node
</code></pre></div>
<p><code>node</code>を見てみましょう。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	path      <span class="token builtin">string</span>
	wildChild <span class="token builtin">bool</span>
	nType     nodeType
	maxParams <span class="token builtin">uint8</span>
	priority  <span class="token builtin">uint32</span>
	indices   <span class="token builtin">string</span>
	children  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node
	handle    Handle
<span class="token punctuation">}</span>
</code></pre></div>
<p>なんとなく見えてきました。</p>
<p><code>node</code>構造体でパスと<code>Handle</code>型を紐付けていて、<code>node</code>を HTTP メソッドごとにツリー構造で管理しているようです。</p>
<p>では<code>*Router.Handle</code>に戻ります。</p>
<ol start="4">
<li>ここは登録したい HTTP メソッドがまだ<code>*Router.trees</code>に登録されていなければ初期化しているようです。</li>
</ol>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">root <span class="token operator">:=</span> r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
	<span class="token keyword">if</span> root <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		root <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
		r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> root

		r<span class="token punctuation">.</span>globalAllowed <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">allowed</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre></div>
<p><code>*Router.allowed(path, reqMethod string) (allow string)</code>は長いので割愛。</p>
<p>一応読みましたが、登録されている HTTP メソッドをカンマ区切りで返すだけです。</p>
<p>しかもその結果を格納している<code>*Router.globalAllowed</code>はどこでも使われていません。</p>
<p>よくわからん。。とりあえずスルー</p>
<ol start="5">
<li>やっと見たいところです。パスに<code>Handle</code>型を紐付けます。</li>
</ol>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">root<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
</code></pre></div>
<p>やはり長い。。。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// addRoute adds a node with the given handle to the path.</span>
<span class="token comment">// Not concurrency-safe!</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fullPath <span class="token operator">:=</span> path
	n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

	<span class="token comment">// Empty tree</span>
	<span class="token keyword">if</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>indices <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>nType <span class="token operator">=</span> root
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

walk<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// Find the longest common prefix.</span>
		<span class="token comment">// This also implies that the common prefix contains no ':' or '*'</span>
		<span class="token comment">// since the existing key can't contain those chars.</span>
		i <span class="token operator">:=</span> <span class="token function">longestCommonPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

		<span class="token comment">// Split edge</span>
		<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			child <span class="token operator">:=</span> node<span class="token punctuation">{</span>
				path<span class="token punctuation">:</span>      n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				wildChild<span class="token punctuation">:</span> n<span class="token punctuation">.</span>wildChild<span class="token punctuation">,</span>
				nType<span class="token punctuation">:</span>     static<span class="token punctuation">,</span>
				indices<span class="token punctuation">:</span>   n<span class="token punctuation">.</span>indices<span class="token punctuation">,</span>
				children<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
				handle<span class="token punctuation">:</span>    n<span class="token punctuation">.</span>handle<span class="token punctuation">,</span>
				priority<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>priority <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span>

			n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span><span class="token operator">&#x26;</span>child<span class="token punctuation">}</span>
			<span class="token comment">// []byte for proper unicode char conversion, see #65</span>
			n<span class="token punctuation">.</span>indices <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
			n<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token boolean">nil</span>
			n<span class="token punctuation">.</span>wildChild <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Make new node a child of this node</span>
		<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			path <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>

			<span class="token keyword">if</span> n<span class="token punctuation">.</span>wildChild <span class="token punctuation">{</span>
				n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

				<span class="token comment">// Check if the wildcard matches</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&#x26;&#x26;</span>
					<span class="token comment">// Adding a child to a catchAll is not possible</span>
					n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token operator">&#x26;&#x26;</span>
					<span class="token comment">// Check for longer wildcard, e.g. :name and :names</span>
					<span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span> walk
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token comment">// Wildcard conflict</span>
					pathSeg <span class="token operator">:=</span> path
					<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token punctuation">{</span>
						pathSeg <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">SplitN</span><span class="token punctuation">(</span>pathSeg<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
					<span class="token punctuation">}</span>
					prefix <span class="token operator">:=</span> fullPath<span class="token punctuation">[</span><span class="token punctuation">:</span>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> pathSeg<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path
					<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"'"</span> <span class="token operator">+</span> pathSeg <span class="token operator">+</span>
						<span class="token string">"' in new path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span>
						<span class="token string">"' conflicts with existing wildcard '"</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path <span class="token operator">+</span>
						<span class="token string">"' in existing prefix '"</span> <span class="token operator">+</span> prefix <span class="token operator">+</span>
						<span class="token string">"'"</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			idxc <span class="token operator">:=</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

			<span class="token comment">// '/' after param</span>
			<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">==</span> param <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token operator">&#x26;&#x26;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
				n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				n<span class="token punctuation">.</span>priority<span class="token operator">++</span>
				<span class="token keyword">continue</span> walk
			<span class="token punctuation">}</span>

			<span class="token comment">// Check if a child with the next path byte exists</span>
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> c <span class="token operator">==</span> idxc <span class="token punctuation">{</span>
					i <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
					n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
					<span class="token keyword">continue</span> walk
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Otherwise insert it</span>
			<span class="token keyword">if</span> idxc <span class="token operator">!=</span> <span class="token string">':'</span> <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">!=</span> <span class="token string">'*'</span> <span class="token punctuation">{</span>
				<span class="token comment">// []byte for proper unicode char conversion, see #65</span>
				n<span class="token punctuation">.</span>indices <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>idxc<span class="token punctuation">}</span><span class="token punctuation">)</span>
				child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span><span class="token punctuation">}</span>
				n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
				n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
				n <span class="token operator">=</span> child
			<span class="token punctuation">}</span>
			n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Otherwise add handle to current node</span>
		<span class="token keyword">if</span> n<span class="token punctuation">.</span>handle <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"a handle is already registered for path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>ここでツリー構造を組み立てています。</p>
<p>ちょっと一つの記事で見ていくには分量が多すぎるのでまた次回にします。。。</p>
<h1>Conclusion</h1>
<p>httprouter の処理の流れとしては</p>
<ol>
<li>HTTP リクエストごとにパスを管理</li>
<li>パスと実行したいハンドラをツリー構造で管理</li>
</ol>
<p>という感じです。</p>
<p>次回以降は</p>
<ol start="2">
<li>パスと実行したいハンドラをツリー構造で管理</li>
</ol>
<p>と、リクエストの際にどのように処理するのか読んでいきます。</p>
<p>コードが短いとはいえ、細かい挙動まで見ていくのは大変ですなあ。</p>
<p>それをするためにこのブログやっているのですがね。</p>
</div><div><h1 class="text-3xl mb-1">Related articles</h1><ol><li><a href="httprouter">この記事</a></li><li><a href="httprouter2">httprouter2</a></li><li><a href="httprouter3">httprouter3</a></li></ol></div></article></main></div><footer class="container mx-auto pb-5 text-center">©<!-- --> <a href="https://github.com/the-coding-dead">github.com/the-coding-dead</a></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"httprouter","code":"func main() {\n\trouter := httprouter.New()\n\trouter.GET(\"/\", Index)\n\trouter.GET(\"/hello/:name\", Hello)\n\n\tlog.Fatal(http.ListenAndServe(\":8080\", router))\n}\n","language":"go","contentHtml":"\u003cp\u003e今日は\u003ca href=\"https://github.com/julienschmidt/httprouter\"\u003ejulienschmidt/httprouter\u003c/a\u003eです。\u003c/p\u003e\n\u003cp\u003eたまに雑な API を Go で作るときに使うのでどのように実装されているか気になってました。\u003c/p\u003e\n\u003cp\u003e見てみます。\u003c/p\u003e\n\u003ch1\u003eRepository\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/julienschmidt/httprouter\"\u003egithub.com/julienschmidt/httprouter\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003ePackage Features - Named parameters\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/julienschmidt/httprouter\"\u003ehttprouter\u003c/a\u003eの一番の\u003ccode\u003enet/http\u003c/code\u003eとの違いは\u003ccode\u003eNamed parameters\u003c/code\u003eだと思います。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003erouter.GET(\"/hello/:name\", Hello)\u003c/code\u003eと登録することで\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ehttprouter.Params.ByName(\"name\")\u003c/code\u003eでパラメータを取得できます。\u003c/p\u003e\n\u003cp\u003eまだいっぱい特徴があるのですが、今回はこの機能に絞ってコードを読んでいきます。\u003c/p\u003e\n\u003ch2\u003erouter.go\u003c/h2\u003e\n\u003cp\u003eコード: \u003ca href=\"https://github.com/julienschmidt/httprouter/blob/master/router.go\"\u003erouter.go\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eReading\u003c/h1\u003e\n\u003cp\u003eまず、必ず呼び出すコンストラクタです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// New returns a new initialized Router.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Path auto-correction, including trailing slashes, is enabled by default.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003eNew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tRedirectTrailingSlash\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\tRedirectFixedPath\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e      \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\tHandleMethodNotAllowed\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\tHandleOPTIONS\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e          \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e返却される\u003ccode\u003e*Router\u003c/code\u003eは\u003ccode\u003enet/http.Handler\u003c/code\u003eインターフェイスを実装しています。\u003c/p\u003e\n\u003cp\u003e下記のコードでわかります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Make sure the Router conforms with the http.Handler interface\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e \u003cspan class=\"token boolean\"\u003e_\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHandler \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eNew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003enet/http\u003c/code\u003eの方も読んでみたくなるなあ。また今度にします。\u003c/p\u003e\n\u003cp\u003e次に実際にパスに登録するための\u003ccode\u003eGET\u003c/code\u003eや\u003ccode\u003ePOST\u003c/code\u003eメソッドです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003erouter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eGET\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/hello/:name\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Hello\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eのように使います。\u003c/p\u003e\n\u003cp\u003eこれは下記のコードです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// GET is a shortcut for router.Handle(http.MethodGet, path, handle)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eGET\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodGet\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// HEAD is a shortcut for router.Handle(http.MethodHead, path, handle)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eHEAD\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodHead\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// OPTIONS is a shortcut for router.Handle(http.MethodOptions, path, handle)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eOPTIONS\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodOptions\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// POST is a shortcut for router.Handle(http.MethodPost, path, handle)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003ePOST\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodPost\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// PUT is a shortcut for router.Handle(http.MethodPut, path, handle)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003ePUT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodPut\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// PATCH is a shortcut for router.Handle(http.MethodPatch, path, handle)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003ePATCH\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodPatch\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// DELETE is a shortcut for router.Handle(http.MethodDelete, path, handle)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eDELETE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodDelete\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003e*Router.Handle\u003c/code\u003eをラップしているだけです。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e*Router.Handle\u003c/code\u003eに HTTP メソッド、パス、\u003ccode\u003eHandle\u003c/code\u003e型を渡します。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eHandle\u003c/code\u003e型は\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e Handle \u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eResponseWriter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRequest\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Params\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eと定義されています。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003enet/http\u003c/code\u003eの\u003ccode\u003eHandlerFunc\u003c/code\u003e型を拡張した型のようです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e HandlerFunc \u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eResponseWriter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRequest\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003eHandle\u003c/code\u003e型の第三引数\u003ccode\u003eParam\u003c/code\u003eは下記です。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Param is a single URL parameter, consisting of a key and a value.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e Param \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tKey   \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\n\tValue \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Params is a Param-slice, as returned by the router.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// The slice is ordered, the first URL parameter is also the first slice value.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// It is therefore safe to read values by the index.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e Params \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003eParam\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e単純にパラメータを格納しておくもののようです。\u003c/p\u003e\n\u003cp\u003eお目当てのパラメータは\u003ccode\u003eParams.ByName\u003c/code\u003eメソッドで取得できます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// ByName returns the value of the first Param which key matches the given name.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// If no matching Param is found, an empty string is returned.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eps Params\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eByName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ename \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token boolean\"\u003e_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e p \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erange\u003c/span\u003e ps \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e p\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eKey \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e name \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e p\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eValue\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eなぜ\u003ccode\u003etype Param map[string]string\u003c/code\u003eで実装しないのでしょうか?\u003c/p\u003e\n\u003cp\u003e理由がありそうなので\u003ccode\u003e*Router.Handle\u003c/code\u003eで実際にどのようにパスと\u003ccode\u003eHandle\u003c/code\u003e型を紐付けているのか見てみます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Handle registers a new request handle with the given path and method.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e//\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// For GET, POST, PUT, PATCH and DELETE requests the respective shortcut\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// functions can be used.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e//\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// This function is intended for bulk loading and to allow the usage of less\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// frequently used, non-standardized or custom methods (e.g. for internal\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// communication with a proxy).\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emethod\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tvarsCount \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003euint16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// 1\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e method \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"method must not be empty\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"path must begin with '/' in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e path \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e handle \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"handle must not be nil\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// 2\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSaveMatchedRoutePath \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tvarsCount\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\t\thandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esaveMatchedRoutePath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// 3\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003emake\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// 4\u003c/span\u003e\n\troot \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003emethod\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e root \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\troot \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003emethod\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e root\n\n\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eglobalAllowed \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eallowed\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// 5\u003c/span\u003e\n\troot\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Update maxParams\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e paramsCount \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003ecountParams\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e paramsCount\u003cspan class=\"token operator\"\u003e+\u003c/span\u003evarsCount \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emaxParams \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emaxParams \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e paramsCount \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e varsCount\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Lazy-init paramsPool alloc func\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eparamsPool\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eNew \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emaxParams \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eparamsPool\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eNew \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tps \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003emake\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eParams\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emaxParams\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003eps\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col\u003e\n\u003cli\u003eバリデーション\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e method \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"method must not be empty\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"path must begin with '/' in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e path \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e handle \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"handle must not be nil\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e\u003ccode\u003e*Router.SaveMatchedRoutePath = true\u003c/code\u003eを設定している場合のみ実行されます。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003ccode\u003eHandle\u003c/code\u003e型の実行の直前に\u003ccode\u003eParams\u003c/code\u003eにパスを追加します。\u003c/p\u003e\n\u003cp\u003e便利やー\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003esaveMatchedRoutePath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e Handle \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eResponseWriter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRequest\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ps Params\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e ps \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tpsp \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetParams\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\tps \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003epsp\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\u003cspan class=\"token comment\"\u003e// ここ\u003c/span\u003e\n\t\t\tps\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e Param\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eKey\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e MatchedRoutePathParam\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Value\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ps\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eputParams\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epsp\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tps \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eps\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Param\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eKey\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e MatchedRoutePathParam\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e Value\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ps\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSaveMatchedRoutePath \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tvarsCount\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\thandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esaveMatchedRoutePath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e\u003ccode\u003e*Router\u003c/code\u003eに対して\u003ccode\u003eHandle\u003c/code\u003eが最初に呼び出された場合は初期化します。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003emake\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eここで\u003ccode\u003e*Router\u003c/code\u003eを見てみることにします。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Router is a http.Handler which can be used to dispatch requests to different\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// handler functions via configurable routes\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e Router \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\ttrees \u003cspan class=\"token keyword\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tRedirectTrailingSlash \u003cspan class=\"token builtin\"\u003ebool\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tRedirectFixedPath \u003cspan class=\"token builtin\"\u003ebool\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tHandleMethodNotAllowed \u003cspan class=\"token builtin\"\u003ebool\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tHandleOPTIONS \u003cspan class=\"token builtin\"\u003ebool\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tGlobalOPTIONS http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHandler\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tglobalAllowed \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tNotFound http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHandler\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tMethodNotAllowed http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHandler\n\n\t\u003cspan class=\"token comment\"\u003e// comments...\u003c/span\u003e\n\tPanicHandler \u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eResponseWriter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRequest\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eここで着目したいのは\u003ccode\u003etrees\u003c/code\u003eフィールドです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003etrees \u003cspan class=\"token keyword\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003enode\u003c/code\u003eを見てみましょう。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e node \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tpath      \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\n\twildChild \u003cspan class=\"token builtin\"\u003ebool\u003c/span\u003e\n\tnType     nodeType\n\tmaxParams \u003cspan class=\"token builtin\"\u003euint8\u003c/span\u003e\n\tpriority  \u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\n\tindices   \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\n\tchildren  \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\n\thandle    Handle\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eなんとなく見えてきました。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003enode\u003c/code\u003e構造体でパスと\u003ccode\u003eHandle\u003c/code\u003e型を紐付けていて、\u003ccode\u003enode\u003c/code\u003eを HTTP メソッドごとにツリー構造で管理しているようです。\u003c/p\u003e\n\u003cp\u003eでは\u003ccode\u003e*Router.Handle\u003c/code\u003eに戻ります。\u003c/p\u003e\n\u003col start=\"4\"\u003e\n\u003cli\u003eここは登録したい HTTP メソッドがまだ\u003ccode\u003e*Router.trees\u003c/code\u003eに登録されていなければ初期化しているようです。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003eroot \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003emethod\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e root \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\troot \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003enew\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003emethod\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e root\n\n\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eglobalAllowed \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eallowed\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"*\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003e*Router.allowed(path, reqMethod string) (allow string)\u003c/code\u003eは長いので割愛。\u003c/p\u003e\n\u003cp\u003e一応読みましたが、登録されている HTTP メソッドをカンマ区切りで返すだけです。\u003c/p\u003e\n\u003cp\u003eしかもその結果を格納している\u003ccode\u003e*Router.globalAllowed\u003c/code\u003eはどこでも使われていません。\u003c/p\u003e\n\u003cp\u003eよくわからん。。とりあえずスルー\u003c/p\u003e\n\u003col start=\"5\"\u003e\n\u003cli\u003eやっと見たいところです。パスに\u003ccode\u003eHandle\u003c/code\u003e型を紐付けます。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003eroot\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eやはり長い。。。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// addRoute adds a node with the given handle to the path.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Not concurrency-safe!\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en \u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eaddRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tfullPath \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Empty tree\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e root\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nwalk\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Find the longest common prefix.\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// This also implies that the common prefix contains no ':' or '*'\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// since the existing key can't contain those chars.\u003c/span\u003e\n\t\ti \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003elongestCommonPrefix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Split edge\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e node\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tpath\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e      n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\twildChild\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e     static\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tindices\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e   n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tchildren\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\thandle\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e    n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tpriority\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Make new node a child of this node\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tpath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\t\t\t\u003cspan class=\"token comment\"\u003e// Check if the wildcard matches\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Adding a child to a catchAll is not possible\u003c/span\u003e\n\t\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e catchAll \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Check for longer wildcard, e.g. :name and :names\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Wildcard conflict\u003c/span\u003e\n\t\t\t\t\tpathSeg \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e catchAll \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\tpathSeg \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e strings\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSplitN\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epathSeg\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\t\tprefix \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003estrings\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIndex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e pathSeg\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\n\t\t\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e pathSeg \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' in new path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' conflicts with existing wildcard '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' in existing prefix '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e prefix \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\tidxc \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// '/' after param\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e param \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// Check if a child with the next path byte exists\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erange\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token function\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e idxc \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\ti \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// Otherwise insert it\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'*'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eidxc\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e child\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Otherwise add handle to current node\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"a handle is already registered for path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e handle\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eここでツリー構造を組み立てています。\u003c/p\u003e\n\u003cp\u003eちょっと一つの記事で見ていくには分量が多すぎるのでまた次回にします。。。\u003c/p\u003e\n\u003ch1\u003eConclusion\u003c/h1\u003e\n\u003cp\u003ehttprouter の処理の流れとしては\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eHTTP リクエストごとにパスを管理\u003c/li\u003e\n\u003cli\u003eパスと実行したいハンドラをツリー構造で管理\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eという感じです。\u003c/p\u003e\n\u003cp\u003e次回以降は\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eパスと実行したいハンドラをツリー構造で管理\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eと、リクエストの際にどのように処理するのか読んでいきます。\u003c/p\u003e\n\u003cp\u003eコードが短いとはいえ、細かい挙動まで見ていくのは大変ですなあ。\u003c/p\u003e\n\u003cp\u003eそれをするためにこのブログやっているのですがね。\u003c/p\u003e\n","title":"httprouter","date":"2021-01-17","description":"Goの有名パッケージhttprouterを読みます。","serialization":["httprouter","httprouter2","httprouter3"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"httprouter"},"buildId":"fHOm68nuVOVSOHJNL3q8N","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-86038f8325ecf14c2308.js"></script><script src="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-e13f5e753692f9663f23.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.73361561705e18283b5e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-a1b5a40e975a4b990753.js" async=""></script><script src="/_next/static/fHOm68nuVOVSOHJNL3q8N/_buildManifest.js" async=""></script><script src="/_next/static/fHOm68nuVOVSOHJNL3q8N/_ssgManifest.js" async=""></script></body></html>