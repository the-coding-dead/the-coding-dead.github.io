<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>httprouter2 - The Coding Dead</title><link rel="icon" href="/favicon.ico"/><meta name="description" content="前回の続きです。httprouterを読みます。"/><meta property="og:image" content="https://raw.githubusercontent.com/the-coding-dead/the-coding-dead.github.io/main/public/images/og-image.png"/><meta name="og:title" content="httprouter2 - The Coding Dead"/><meta name="og:description" content="前回の続きです。httprouterを読みます。"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/b9772c72096ad1651865.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b9772c72096ad1651865.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-e13f5e753692f9663f23.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.73361561705e18283b5e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-a1b5a40e975a4b990753.js" as="script"/></head><body><div id="__next"><div class="bg-gray-800 h-auto w-screen p-3"><div class="cursor-pointer hover:opacity-75"><div><p class="text-3xl font-bold mb-2">The Coding Dead</p><p class="text-xs">窒息するほどコードを読んで<br/>スーパーエンジニアになった気になる</p></div></div></div><div class="container mx-auto"><div class="container h-screen flex flex-col"><div class="container px-2 flex-grow "><main><article class="relative container mt-5 p-3 bg-gray-600 rounded"><div class="absolute top-2 right-2 bg-gray-700 h-4 w-4 rounded-full"></div><h1 class="text-3xl mb-1">httprouter2</h1><div class="text-sm"><p>Related articles</p><ol><li><a href="httprouter">httprouter</a></li><li><a href="httprouter2">この記事</a></li><li><a href="httprouter3">httprouter3</a></li></ol></div><time dateTime="2021-01-18">January 18, 2021</time><pre class="my-0 p-0" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e;padding:1em;margin:.5em 0;overflow:auto"><code class="language-go" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e"><span class="token" style="color:#47ebb4">func</span><span> </span><span class="token" style="color:#57718e">main</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span>
</span><span>	router </span><span class="token" style="color:#0aa370">:=</span><span> httprouter</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">New</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span>	router</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">GET</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;/&quot;</span><span class="token" style="color:#4a5f78">,</span><span> Index</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span>	router</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">GET</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;/hello/:name&quot;</span><span class="token" style="color:#4a5f78">,</span><span> Hello</span><span class="token" style="color:#4a5f78">)</span><span>
</span>
<span>	log</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">Fatal</span><span class="token" style="color:#4a5f78">(</span><span>http</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">ListenAndServe</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;:8080&quot;</span><span class="token" style="color:#4a5f78">,</span><span> router</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span></span><span class="token" style="color:#4a5f78">}</span><span>
</span>
</code></pre><div><p>前回から引き続き Go の<a href="https://github.com/julienschmidt/httprouter">julienschmidt/httprouter</a>を読んでいきます！</p>
<h1>Repository</h1>
<p><a href="https://github.com/julienschmidt/httprouter">github.com/julienschmidt/httprouter</a></p>
<h2>router.go</h2>
<p>コード: <a href="https://github.com/julienschmidt/httprouter/blob/master/router.go">router.go</a></p>
<h1>Review</h1>
<p>前回の復習</p>
<p>httprouter の処理の流れは</p>
<ol>
<li>HTTP リクエストごとにパスを管理</li>
<li>パスと実行したいハンドラをツリー構造で管理</li>
</ol>
<p>だとわかりました。</p>
<p>パスと<code>Handle</code>を紐付けるときに呼ばれるのが<code>*Router.Handle</code>で</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">Handle</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	root<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>その内部で呼ばれるのが<code>*node.addRoute</code>でした。</p>
<p>今日はこの中を見ることで</p>
<ol start="2">
<li>パスと実行したいハンドラをツリー構造で管理</li>
</ol>
<p>する方法を理解していきます。</p>
<h1>Reading</h1>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fullPath <span class="token operator">:=</span> path
	n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

	<span class="token comment">// Empty tree</span>
	<span class="token keyword">if</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>indices <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>nType <span class="token operator">=</span> root
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

walk<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// Find the longest common prefix.</span>
		<span class="token comment">// This also implies that the common prefix contains no ':' or '*'</span>
		<span class="token comment">// since the existing key can't contain those chars.</span>
		i <span class="token operator">:=</span> <span class="token function">longestCommonPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

		<span class="token comment">// Split edge</span>
		<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			child <span class="token operator">:=</span> node<span class="token punctuation">{</span>
				path<span class="token punctuation">:</span>      n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				wildChild<span class="token punctuation">:</span> n<span class="token punctuation">.</span>wildChild<span class="token punctuation">,</span>
				nType<span class="token punctuation">:</span>     static<span class="token punctuation">,</span>
				indices<span class="token punctuation">:</span>   n<span class="token punctuation">.</span>indices<span class="token punctuation">,</span>
				children<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
				handle<span class="token punctuation">:</span>    n<span class="token punctuation">.</span>handle<span class="token punctuation">,</span>
				priority<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>priority <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span>

			n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span><span class="token operator">&#x26;</span>child<span class="token punctuation">}</span>
			<span class="token comment">// []byte for proper unicode char conversion, see #65</span>
			n<span class="token punctuation">.</span>indices <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
			n<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token boolean">nil</span>
			n<span class="token punctuation">.</span>wildChild <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Make new node a child of this node</span>
		<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			path <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>

			<span class="token keyword">if</span> n<span class="token punctuation">.</span>wildChild <span class="token punctuation">{</span>
				n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

				<span class="token comment">// Check if the wildcard matches</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&#x26;&#x26;</span>
					<span class="token comment">// Adding a child to a catchAll is not possible</span>
					n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token operator">&#x26;&#x26;</span>
					<span class="token comment">// Check for longer wildcard, e.g. :name and :names</span>
					<span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span> walk
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token comment">// Wildcard conflict</span>
					pathSeg <span class="token operator">:=</span> path
					<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token punctuation">{</span>
						pathSeg <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">SplitN</span><span class="token punctuation">(</span>pathSeg<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
					<span class="token punctuation">}</span>
					prefix <span class="token operator">:=</span> fullPath<span class="token punctuation">[</span><span class="token punctuation">:</span>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> pathSeg<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path
					<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"'"</span> <span class="token operator">+</span> pathSeg <span class="token operator">+</span>
						<span class="token string">"' in new path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span>
						<span class="token string">"' conflicts with existing wildcard '"</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path <span class="token operator">+</span>
						<span class="token string">"' in existing prefix '"</span> <span class="token operator">+</span> prefix <span class="token operator">+</span>
						<span class="token string">"'"</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			idxc <span class="token operator">:=</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

			<span class="token comment">// '/' after param</span>
			<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">==</span> param <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token operator">&#x26;&#x26;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
				n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				n<span class="token punctuation">.</span>priority<span class="token operator">++</span>
				<span class="token keyword">continue</span> walk
			<span class="token punctuation">}</span>

			<span class="token comment">// Check if a child with the next path byte exists</span>
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> c <span class="token operator">==</span> idxc <span class="token punctuation">{</span>
					i <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
					n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
					<span class="token keyword">continue</span> walk
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Otherwise insert it</span>
			<span class="token keyword">if</span> idxc <span class="token operator">!=</span> <span class="token string">':'</span> <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">!=</span> <span class="token string">'*'</span> <span class="token punctuation">{</span>
				<span class="token comment">// []byte for proper unicode char conversion, see #65</span>
				n<span class="token punctuation">.</span>indices <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>idxc<span class="token punctuation">}</span><span class="token punctuation">)</span>
				child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span><span class="token punctuation">}</span>
				n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
				n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
				n <span class="token operator">=</span> child
			<span class="token punctuation">}</span>
			n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Otherwise add handle to current node</span>
		<span class="token keyword">if</span> n<span class="token punctuation">.</span>handle <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"a handle is already registered for path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>まず、<code>*node</code>がまっさらの状態で<code>*node.addRoute</code>が呼ばれたときの処理を見ます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fullPath <span class="token operator">:=</span> path
	n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

	<span class="token comment">// Empty tree</span>
	<span class="token keyword">if</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>indices <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>nType <span class="token operator">=</span> root
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
</code></pre></div>
<p>ここまでで良さそうです。</p>
<p><code>*node.priority</code>が何に使われるのかはちょっとまだわからないので無視して進みます。</p>
<p><code>*node.insertChild</code>を見てみましょう。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// Find prefix until first wildcard</span>
		wildcard<span class="token punctuation">,</span> i<span class="token punctuation">,</span> valid <span class="token operator">:=</span> <span class="token function">findWildcard</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// No wilcard found</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// The wildcard name must not contain ':' and '*'</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>valid <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"only one wildcard per path segment is allowed, has: '"</span> <span class="token operator">+</span>
				wildcard <span class="token operator">+</span> <span class="token string">"' in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Check if the wildcard has a name</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"wildcards must be named with a non-empty name in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Check if this node has existing children which would be</span>
		<span class="token comment">// unreachable if we insert the wildcard here</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"wildcard segment '"</span> <span class="token operator">+</span> wildcard <span class="token operator">+</span>
				<span class="token string">"' conflicts with existing children in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// param</span>
		<span class="token keyword">if</span> wildcard<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">':'</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> i <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token comment">// Insert prefix before the current wildcard</span>
				n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
				path <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span>

			n<span class="token punctuation">.</span>wildChild <span class="token operator">=</span> <span class="token boolean">true</span>
			child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span>
				nType<span class="token punctuation">:</span> param<span class="token punctuation">,</span>
				path<span class="token punctuation">:</span>  wildcard<span class="token punctuation">,</span>
			<span class="token punctuation">}</span>
			n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>child<span class="token punctuation">}</span>
			n <span class="token operator">=</span> child
			n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

			<span class="token comment">// If the path doesn't end with the wildcard, then there</span>
			<span class="token comment">// will be another non-wildcard subpath starting with '/'</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
				child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span>
					priority<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
				n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>child<span class="token punctuation">}</span>
				n <span class="token operator">=</span> child
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Otherwise we're done. Insert the handle in the new leaf</span>
			n<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// catchAll</span>
		<span class="token keyword">if</span> i<span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"catch-all routes are only allowed at the end of the path in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"catch-all conflicts with existing handle for the path segment root in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Currently fixed width 1 for '/'</span>
		i<span class="token operator">--</span>
		<span class="token keyword">if</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"no / before catch-all in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>

		<span class="token comment">// First node: catchAll node with empty path</span>
		child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span>
			wildChild<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			nType<span class="token punctuation">:</span>     catchAll<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>child<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>indices <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
		n <span class="token operator">=</span> child
		n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

		<span class="token comment">// Second node: node holding the variable</span>
		child <span class="token operator">=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span>
			path<span class="token punctuation">:</span>     path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			nType<span class="token punctuation">:</span>    catchAll<span class="token punctuation">,</span>
			handle<span class="token punctuation">:</span>   handle<span class="token punctuation">,</span>
			priority<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>child<span class="token punctuation">}</span>

		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// If no wildcard was found, simply insert the path and handle</span>
	n<span class="token punctuation">.</span>path <span class="token operator">=</span> path
	n<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle
<span class="token punctuation">}</span>
</code></pre></div>
<p>これも長い。。。</p>
<p>丁寧に読んでいきます。</p>
<p>無限ループの直後</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Find prefix until first wildcard</span>
wildcard<span class="token punctuation">,</span> i<span class="token punctuation">,</span> valid <span class="token operator">:=</span> <span class="token function">findWildcard</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
</code></pre></div>
<p>最初のワイルドカードまでを取得しています。</p>
<p>ワイルドカードとは<code>:</code>と<code>*</code>ではじまるセグメントです。</p>
<p><code>:</code>は前回、<code>Named parameters</code>と紹介しましたが、<code>*</code>で始まるものは<code>Catch-All parameters</code>というものです。</p>
<p>下記のようにマッチします。(<a href="https://github.com/julienschmidt/httprouter#catch-all-parameters">README 参照</a>)</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Pattern: /src/*filepath

 /src/                     match
 /src/somefile.go          match
 /src/subdir/somefile.go   match</code></pre></div>
<p>では、<code>findWildcard</code>を読んでいきます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Search for a wildcard segment and check the name for invalid characters.</span>
<span class="token comment">// Returns -1 as index, if no wildcard was found.</span>
<span class="token keyword">func</span> <span class="token function">findWildcard</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>wilcard <span class="token builtin">string</span><span class="token punctuation">,</span> i <span class="token builtin">int</span><span class="token punctuation">,</span> valid <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Find start</span>
	<span class="token comment">// 1</span>
	<span class="token keyword">for</span> start<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 2</span>
		<span class="token comment">// A wildcard starts with ':' (param) or '*' (catch-all)</span>
		<span class="token keyword">if</span> c <span class="token operator">!=</span> <span class="token string">':'</span> <span class="token operator">&#x26;&#x26;</span> c <span class="token operator">!=</span> <span class="token string">'*'</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 3</span>
		<span class="token comment">// Find end and check for invalid characters</span>
		valid <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token keyword">for</span> end<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>start<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">switch</span> c <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token string">'/'</span><span class="token punctuation">:</span>
				<span class="token keyword">return</span> path<span class="token punctuation">[</span>start <span class="token punctuation">:</span> start<span class="token operator">+</span><span class="token number">1</span><span class="token operator">+</span>end<span class="token punctuation">]</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> valid
			<span class="token keyword">case</span> <span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">:</span>
				valid <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> path<span class="token punctuation">[</span>start<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> valid
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>非常にシンプルです。</p>
<ol>
<li>パスを一文字ずつループして</li>
<li>ワイルドカードじゃなかったら次</li>
<li>ワイルドカードが何なのか調べて、ついでにワイルドカードの文法エラーをチェック</li>
</ol>
<p>という感じです。</p>
<p>返却値は</p>
<p>ワイルドカード、ワイルドカードのインデックス、文法エラーがないか</p>
<p>です。</p>
<p>ここで初めて気づいたのですが、</p>
<p><a href="https://github.com/julienschmidt/httprouter">julienschmidt/httprouter</a>は</p>
<p><a href="https://tour.golang.org/basics/7"><code>Named return values</code></a>を多用しています。</p>
<p>基本的に使うべきでないと思っていたので使用を避けていましたが、ドキュメントとしての効力がめちゃくちゃ高いなと思いました。</p>
<ul>
<li>複数の返却値を返す</li>
<li>返却値が関数名から読み取れない</li>
<li>関数が割と短い</li>
</ul>
<p>場合は使っていこうと思います。</p>
<p>では、<code>*node.insertChild</code>に戻ります。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// Find prefix until first wildcard</span>
		wildcard<span class="token punctuation">,</span> i<span class="token punctuation">,</span> valid <span class="token operator">:=</span> <span class="token function">findWildcard</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// No wilcard found</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// The wildcard name must not contain ':' and '*'</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>valid <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"only one wildcard per path segment is allowed, has: '"</span> <span class="token operator">+</span>
				wildcard <span class="token operator">+</span> <span class="token string">"' in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Check if the wildcard has a name</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"wildcards must be named with a non-empty name in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Check if this node has existing children which would be</span>
		<span class="token comment">// unreachable if we insert the wildcard here</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"wildcard segment '"</span> <span class="token operator">+</span> wildcard <span class="token operator">+</span>
				<span class="token string">"' conflicts with existing children in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
</code></pre></div>
<p>findWildcard 後<code>if</code>は wildcard がなかった場合にすぐに関数最後に移動します。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// If no wildcard was found, simply insert the path and handle</span>
n<span class="token punctuation">.</span>path <span class="token operator">=</span> path
n<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle
</code></pre></div>
<p>パスと<code>Handle</code>を紐付けています。</p>
<p>次の<code>if</code>3 連発はバリデーションですね。</p>
<p>次に移ります。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// param</span>
<span class="token keyword">if</span> wildcard<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">':'</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> i <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// Insert prefix before the current wildcard</span>
		n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
		path <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>

	n<span class="token punctuation">.</span>wildChild <span class="token operator">=</span> <span class="token boolean">true</span>
	child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span>
		nType<span class="token punctuation">:</span> param<span class="token punctuation">,</span>
    path<span class="token punctuation">:</span>  wildcard<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>child<span class="token punctuation">}</span>
	n <span class="token operator">=</span> child
	n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

	<span class="token comment">// If the path doesn't end with the wildcard, then there</span>
	<span class="token comment">// will be another non-wildcard subpath starting with '/'</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
		child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span>
			priority<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>child<span class="token punctuation">}</span>
		n <span class="token operator">=</span> child
		<span class="token keyword">continue</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Otherwise we're done. Insert the handle in the new leaf</span>
	n<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">if</span> wildcard<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">':'</span> <span class="token punctuation">{</span>
</code></pre></div>
<p>なので<code>Named parameters</code>についてのようです。</p>
<p>やっていることは単純で、</p>
<p><code>*node.children</code>に<code>Named parameters</code>として<code>*node</code>を追加し、</p>
<p><code>/:hoge/huga</code>のように<code>Named parameters</code>の配下にサブパスがある場合はそのサブパスを先程追加した<code>Named paramters</code>の<code>*node</code>の<code>children</code>に追加しています。</p>
<p><code>/:hoge/huga/:piyo</code>のような場合があるので上記を何度も繰り返します。</p>
<p>最後に<code>*node</code>に<code>Handle</code>を紐付けています。</p>
<p>やっと見えてきました。。。</p>
<p>次行きます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// catchAll</span>
<span class="token keyword">if</span> i<span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>wildcard<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"catch-all routes are only allowed at the end of the path in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"catch-all conflicts with existing handle for the path segment root in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Currently fixed width 1 for '/'</span>
i<span class="token operator">--</span>
<span class="token keyword">if</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"no / before catch-all in path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>

<span class="token comment">// First node: catchAll node with empty path</span>
child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span>
	wildChild<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	nType<span class="token punctuation">:</span>     catchAll<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>child<span class="token punctuation">}</span>
n<span class="token punctuation">.</span>indices <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
n <span class="token operator">=</span> child
n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

<span class="token comment">// Second node: node holding the variable</span>
child <span class="token operator">=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span>
	path<span class="token punctuation">:</span>     path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	nType<span class="token punctuation">:</span>    catchAll<span class="token punctuation">,</span>
	handle<span class="token punctuation">:</span>   handle<span class="token punctuation">,</span>
	priority<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span>child<span class="token punctuation">}</span>

<span class="token keyword">return</span>
</code></pre></div>
<p>こちらは<code>Catch-All parameters</code>の処理です。</p>
<p>バリデーションと<code>Named paramters</code>とほぼ同じ処理があります。</p>
<p><code>Named paramters</code>と違い、<code>/*hoge/huga</code>のような指定はできないので</p>
<p>サブパスの処理はないです。</p>
<p>これでパスと<code>Handle</code>をどのように紐付けているのか、</p>
<p><code>Named paramters</code>と<code>Catch-All parameters</code>はどのように処理するのかがわかりました。</p>
<p>とりあえず今回はこのへんにしときます。。。</p>
<h1>Conclusion</h1>
<p>今回は主に<code>*node.insertChild</code>について見てきました。</p>
<p><code>Named paramters</code>と<code>Catch-All parameters</code>をどのように処理するのかは非常に勉強になりました。</p>
<p>次回は<code>*node.insertChild</code>を呼び出している<code>*node.addRoute</code>に戻って処理を見ていきます。</p>
<p>今更ですが、<code>*Router.ServeHTTP</code>を先に読んでおけばここまで読んだ文を理解するのがもっと楽だった気がします。。。</p>
<p>以上です。</p>
</div><div><h1 class="text-3xl mb-1">Related articles</h1><ol><li><a href="httprouter">httprouter</a></li><li><a href="httprouter2">この記事</a></li><li><a href="httprouter3">httprouter3</a></li></ol></div></article></main></div><footer class="container mx-auto pb-5 text-center">©<!-- --> <a href="https://github.com/the-coding-dead">github.com/the-coding-dead</a></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"httprouter2","code":"func main() {\n\trouter := httprouter.New()\n\trouter.GET(\"/\", Index)\n\trouter.GET(\"/hello/:name\", Hello)\n\n\tlog.Fatal(http.ListenAndServe(\":8080\", router))\n}\n","language":"go","contentHtml":"\u003cp\u003e前回から引き続き Go の\u003ca href=\"https://github.com/julienschmidt/httprouter\"\u003ejulienschmidt/httprouter\u003c/a\u003eを読んでいきます！\u003c/p\u003e\n\u003ch1\u003eRepository\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/julienschmidt/httprouter\"\u003egithub.com/julienschmidt/httprouter\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003erouter.go\u003c/h2\u003e\n\u003cp\u003eコード: \u003ca href=\"https://github.com/julienschmidt/httprouter/blob/master/router.go\"\u003erouter.go\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eReview\u003c/h1\u003e\n\u003cp\u003e前回の復習\u003c/p\u003e\n\u003cp\u003ehttprouter の処理の流れは\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eHTTP リクエストごとにパスを管理\u003c/li\u003e\n\u003cli\u003eパスと実行したいハンドラをツリー構造で管理\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eだとわかりました。\u003c/p\u003e\n\u003cp\u003eパスと\u003ccode\u003eHandle\u003c/code\u003eを紐付けるときに呼ばれるのが\u003ccode\u003e*Router.Handle\u003c/code\u003eで\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emethod\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\troot\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eその内部で呼ばれるのが\u003ccode\u003e*node.addRoute\u003c/code\u003eでした。\u003c/p\u003e\n\u003cp\u003e今日はこの中を見ることで\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003eパスと実行したいハンドラをツリー構造で管理\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eする方法を理解していきます。\u003c/p\u003e\n\u003ch1\u003eReading\u003c/h1\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en \u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eaddRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tfullPath \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Empty tree\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e root\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nwalk\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Find the longest common prefix.\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// This also implies that the common prefix contains no ':' or '*'\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// since the existing key can't contain those chars.\u003c/span\u003e\n\t\ti \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003elongestCommonPrefix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Split edge\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e node\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tpath\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e      n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\twildChild\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e     static\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tindices\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e   n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tchildren\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\thandle\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e    n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tpriority\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Make new node a child of this node\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tpath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\t\t\t\u003cspan class=\"token comment\"\u003e// Check if the wildcard matches\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Adding a child to a catchAll is not possible\u003c/span\u003e\n\t\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e catchAll \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Check for longer wildcard, e.g. :name and :names\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Wildcard conflict\u003c/span\u003e\n\t\t\t\t\tpathSeg \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e catchAll \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\tpathSeg \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e strings\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSplitN\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epathSeg\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\t\tprefix \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003estrings\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIndex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e pathSeg\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\n\t\t\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e pathSeg \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' in new path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' conflicts with existing wildcard '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' in existing prefix '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e prefix \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\tidxc \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// '/' after param\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e param \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// Check if a child with the next path byte exists\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erange\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token function\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e idxc \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\ti \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// Otherwise insert it\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'*'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eidxc\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e child\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Otherwise add handle to current node\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"a handle is already registered for path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e handle\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eまず、\u003ccode\u003e*node\u003c/code\u003eがまっさらの状態で\u003ccode\u003e*node.addRoute\u003c/code\u003eが呼ばれたときの処理を見ます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en \u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eaddRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tfullPath \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Empty tree\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e root\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eここまでで良さそうです。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e*node.priority\u003c/code\u003eが何に使われるのかはちょっとまだわからないので無視して進みます。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e*node.insertChild\u003c/code\u003eを見てみましょう。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en \u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Find prefix until first wildcard\u003c/span\u003e\n\t\twildcard\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e valid \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003efindWildcard\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// No wilcard found\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// The wildcard name must not contain ':' and '*'\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003evalid \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"only one wildcard per path segment is allowed, has: '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\twildcard \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"' in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Check if the wildcard has a name\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewildcard\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"wildcards must be named with a non-empty name in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Check if this node has existing children which would be\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// unreachable if we insert the wildcard here\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"wildcard segment '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e wildcard \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token string\"\u003e\"' conflicts with existing children in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// param\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e wildcard\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token comment\"\u003e// Insert prefix before the current wildcard\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\tpath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\t\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e param\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tpath\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  wildcard\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// If the path doesn't end with the wildcard, then there\u003c/span\u003e\n\t\t\t\u003cspan class=\"token comment\"\u003e// will be another non-wildcard subpath starting with '/'\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewildcard\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tpath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewildcard\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\tpriority\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// Otherwise we're done. Insert the handle in the new leaf\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e handle\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// catchAll\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewildcard\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"catch-all routes are only allowed at the end of the path in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"catch-all conflicts with existing handle for the path segment root in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Currently fixed width 1 for '/'\u003c/span\u003e\n\t\ti\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"no / before catch-all in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// First node: catchAll node with empty path\u003c/span\u003e\n\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\twildChild\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e     catchAll\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Second node: node holding the variable\u003c/span\u003e\n\t\tchild \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tpath\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e     path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e    catchAll\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\thandle\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e   handle\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\tpriority\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// If no wildcard was found, simply insert the path and handle\u003c/span\u003e\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e handle\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれも長い。。。\u003c/p\u003e\n\u003cp\u003e丁寧に読んでいきます。\u003c/p\u003e\n\u003cp\u003e無限ループの直後\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Find prefix until first wildcard\u003c/span\u003e\nwildcard\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e valid \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003efindWildcard\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e最初のワイルドカードまでを取得しています。\u003c/p\u003e\n\u003cp\u003eワイルドカードとは\u003ccode\u003e:\u003c/code\u003eと\u003ccode\u003e*\u003c/code\u003eではじまるセグメントです。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e:\u003c/code\u003eは前回、\u003ccode\u003eNamed parameters\u003c/code\u003eと紹介しましたが、\u003ccode\u003e*\u003c/code\u003eで始まるものは\u003ccode\u003eCatch-All parameters\u003c/code\u003eというものです。\u003c/p\u003e\n\u003cp\u003e下記のようにマッチします。(\u003ca href=\"https://github.com/julienschmidt/httprouter#catch-all-parameters\"\u003eREADME 参照\u003c/a\u003e)\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003ePattern: /src/*filepath\n\n /src/                     match\n /src/somefile.go          match\n /src/subdir/somefile.go   match\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eでは、\u003ccode\u003efindWildcard\u003c/code\u003eを読んでいきます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Search for a wildcard segment and check the name for invalid characters.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Returns -1 as index, if no wildcard was found.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003efindWildcard\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewilcard \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e i \u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e valid \u003cspan class=\"token builtin\"\u003ebool\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// Find start\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// 1\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e start\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erange\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token function\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// 2\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// A wildcard starts with ':' (param) or '*' (catch-all)\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'*'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// 3\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Find end and check for invalid characters\u003c/span\u003e\n\t\tvalid \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e end\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erange\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token function\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estart\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eswitch\u003c/span\u003e c \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estart \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e start\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003eend\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e start\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e valid\n\t\t\t\u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\t\t\t\tvalid \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003estart\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e start\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e valid\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e非常にシンプルです。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eパスを一文字ずつループして\u003c/li\u003e\n\u003cli\u003eワイルドカードじゃなかったら次\u003c/li\u003e\n\u003cli\u003eワイルドカードが何なのか調べて、ついでにワイルドカードの文法エラーをチェック\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eという感じです。\u003c/p\u003e\n\u003cp\u003e返却値は\u003c/p\u003e\n\u003cp\u003eワイルドカード、ワイルドカードのインデックス、文法エラーがないか\u003c/p\u003e\n\u003cp\u003eです。\u003c/p\u003e\n\u003cp\u003eここで初めて気づいたのですが、\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/julienschmidt/httprouter\"\u003ejulienschmidt/httprouter\u003c/a\u003eは\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://tour.golang.org/basics/7\"\u003e\u003ccode\u003eNamed return values\u003c/code\u003e\u003c/a\u003eを多用しています。\u003c/p\u003e\n\u003cp\u003e基本的に使うべきでないと思っていたので使用を避けていましたが、ドキュメントとしての効力がめちゃくちゃ高いなと思いました。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e複数の返却値を返す\u003c/li\u003e\n\u003cli\u003e返却値が関数名から読み取れない\u003c/li\u003e\n\u003cli\u003e関数が割と短い\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e場合は使っていこうと思います。\u003c/p\u003e\n\u003cp\u003eでは、\u003ccode\u003e*node.insertChild\u003c/code\u003eに戻ります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en \u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Find prefix until first wildcard\u003c/span\u003e\n\t\twildcard\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e valid \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003efindWildcard\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// No wilcard found\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// The wildcard name must not contain ':' and '*'\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003evalid \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"only one wildcard per path segment is allowed, has: '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\twildcard \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"' in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Check if the wildcard has a name\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewildcard\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"wildcards must be named with a non-empty name in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Check if this node has existing children which would be\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// unreachable if we insert the wildcard here\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"wildcard segment '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e wildcard \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token string\"\u003e\"' conflicts with existing children in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003efindWildcard 後\u003ccode\u003eif\u003c/code\u003eは wildcard がなかった場合にすぐに関数最後に移動します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// If no wildcard was found, simply insert the path and handle\u003c/span\u003e\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e handle\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eパスと\u003ccode\u003eHandle\u003c/code\u003eを紐付けています。\u003c/p\u003e\n\u003cp\u003e次の\u003ccode\u003eif\u003c/code\u003e3 連発はバリデーションですね。\u003c/p\u003e\n\u003cp\u003e次に移ります。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// param\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e wildcard\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Insert prefix before the current wildcard\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\tpath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\n\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e param\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    path\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  wildcard\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// If the path doesn't end with the wildcard, then there\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// will be another non-wildcard subpath starting with '/'\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewildcard\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tpath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewildcard\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tpriority\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Otherwise we're done. Insert the handle in the new leaf\u003c/span\u003e\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e handle\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e wildcard\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eなので\u003ccode\u003eNamed parameters\u003c/code\u003eについてのようです。\u003c/p\u003e\n\u003cp\u003eやっていることは単純で、\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e*node.children\u003c/code\u003eに\u003ccode\u003eNamed parameters\u003c/code\u003eとして\u003ccode\u003e*node\u003c/code\u003eを追加し、\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e/:hoge/huga\u003c/code\u003eのように\u003ccode\u003eNamed parameters\u003c/code\u003eの配下にサブパスがある場合はそのサブパスを先程追加した\u003ccode\u003eNamed paramters\u003c/code\u003eの\u003ccode\u003e*node\u003c/code\u003eの\u003ccode\u003echildren\u003c/code\u003eに追加しています。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e/:hoge/huga/:piyo\u003c/code\u003eのような場合があるので上記を何度も繰り返します。\u003c/p\u003e\n\u003cp\u003e最後に\u003ccode\u003e*node\u003c/code\u003eに\u003ccode\u003eHandle\u003c/code\u003eを紐付けています。\u003c/p\u003e\n\u003cp\u003eやっと見えてきました。。。\u003c/p\u003e\n\u003cp\u003e次行きます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// catchAll\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewildcard\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"catch-all routes are only allowed at the end of the path in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"catch-all conflicts with existing handle for the path segment root in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Currently fixed width 1 for '/'\u003c/span\u003e\ni\u003cspan class=\"token operator\"\u003e--\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"no / before catch-all in path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// First node: catchAll node with empty path\u003c/span\u003e\nchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\twildChild\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e     catchAll\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Second node: node holding the variable\u003c/span\u003e\nchild \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tpath\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e     path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e    catchAll\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\thandle\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e   handle\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\tpriority\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこちらは\u003ccode\u003eCatch-All parameters\u003c/code\u003eの処理です。\u003c/p\u003e\n\u003cp\u003eバリデーションと\u003ccode\u003eNamed paramters\u003c/code\u003eとほぼ同じ処理があります。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eNamed paramters\u003c/code\u003eと違い、\u003ccode\u003e/*hoge/huga\u003c/code\u003eのような指定はできないので\u003c/p\u003e\n\u003cp\u003eサブパスの処理はないです。\u003c/p\u003e\n\u003cp\u003eこれでパスと\u003ccode\u003eHandle\u003c/code\u003eをどのように紐付けているのか、\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eNamed paramters\u003c/code\u003eと\u003ccode\u003eCatch-All parameters\u003c/code\u003eはどのように処理するのかがわかりました。\u003c/p\u003e\n\u003cp\u003eとりあえず今回はこのへんにしときます。。。\u003c/p\u003e\n\u003ch1\u003eConclusion\u003c/h1\u003e\n\u003cp\u003e今回は主に\u003ccode\u003e*node.insertChild\u003c/code\u003eについて見てきました。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eNamed paramters\u003c/code\u003eと\u003ccode\u003eCatch-All parameters\u003c/code\u003eをどのように処理するのかは非常に勉強になりました。\u003c/p\u003e\n\u003cp\u003e次回は\u003ccode\u003e*node.insertChild\u003c/code\u003eを呼び出している\u003ccode\u003e*node.addRoute\u003c/code\u003eに戻って処理を見ていきます。\u003c/p\u003e\n\u003cp\u003e今更ですが、\u003ccode\u003e*Router.ServeHTTP\u003c/code\u003eを先に読んでおけばここまで読んだ文を理解するのがもっと楽だった気がします。。。\u003c/p\u003e\n\u003cp\u003e以上です。\u003c/p\u003e\n","title":"httprouter2","date":"2021-01-18","description":"前回の続きです。httprouterを読みます。","serialization":["httprouter","httprouter2","httprouter3"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"httprouter2"},"buildId":"ovjrb9wY70rmT43pibhRJ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-86038f8325ecf14c2308.js"></script><script src="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-e13f5e753692f9663f23.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.73361561705e18283b5e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-a1b5a40e975a4b990753.js" async=""></script><script src="/_next/static/ovjrb9wY70rmT43pibhRJ/_buildManifest.js" async=""></script><script src="/_next/static/ovjrb9wY70rmT43pibhRJ/_ssgManifest.js" async=""></script></body></html>