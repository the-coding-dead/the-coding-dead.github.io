<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>xv6 - ls</title><link rel="icon" href="/favicon.ico"/><meta name="description" content="今日は最初ということで教育用のlinuxのlsを読みます。"/><meta property="og:image" content="https://raw.githubusercontent.com/the-coding-dead/the-coding-dead.github.io/main/public/images/og-image.png"/><meta name="og:title" content="xv6 - ls"/><meta name="og:description" content="今日は最初ということで教育用のlinuxのlsを読みます。"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/55c8e6fbb7f90d7e149c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/55c8e6fbb7f90d7e149c.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-88fadddb26c5e799d42f.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.c645823ab151cf7b449d.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-56b0fb255e18ef8fb0ae.js" as="script"/></head><body><div id="__next"><div class="container h-screen flex flex-col min-h-screen"><div class="flex items-center justify-start bg-gray-800 h-auto p-3"><div class="cursor-pointer hover:opacity-75"><div><p class="text-3xl font-bold ">The Coding Dead</p><p class="text-xs">コードを窒息するほど読んで<br/>スーパーエンジニアになった気になる</p></div></div></div><div class="container mx-2 px-4 mx-auto flex-grow"><main><article class="relative container mt-5 p-3 bg-gray-600 rounded"><div class="absolute top-2 right-2 bg-gray-700 h-4 w-4 rounded-full"></div><h1 class="text-3xl mb-1">xv6 - ls</h1><time dateTime="2021-01-16">January 16, 2021</time><pre class="my-0 p-0" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e;padding:1em;margin:.5em 0;overflow:auto"><code class="language-c" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e"><span class="token" style="color:#47ebb4">int</span><span> </span><span class="token" style="color:#57718e">main</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">int</span><span> argc</span><span class="token" style="color:#4a5f78">,</span><span> </span><span class="token" style="color:#47ebb4">char</span><span> </span><span class="token" style="color:#0aa370">*</span><span>argv</span><span class="token" style="color:#4a5f78">[</span><span class="token" style="color:#4a5f78">]</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span>
</span><span>  </span><span class="token" style="color:#47ebb4">if</span><span> </span><span class="token" style="color:#4a5f78">(</span><span>argc </span><span class="token" style="color:#0aa370">&lt;</span><span> </span><span class="token" style="color:#0aa370">2</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span>
</span><span>    </span><span class="token" style="color:#57718e">ls</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;.&quot;</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">;</span><span>
</span><span>    </span><span class="token" style="color:#57718e">exit</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#0aa370">0</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">;</span><span>
</span><span>  </span><span class="token" style="color:#4a5f78">}</span><span>
</span>
<span>  </span><span class="token" style="color:#47ebb4">for</span><span> </span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">int</span><span> i </span><span class="token" style="color:#0aa370">=</span><span> </span><span class="token" style="color:#0aa370">1</span><span class="token" style="color:#4a5f78">;</span><span> i </span><span class="token" style="color:#0aa370">&lt;</span><span> argc</span><span class="token" style="color:#4a5f78">;</span><span> i</span><span class="token" style="color:#0aa370">++</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span>    </span><span class="token" style="color:#57718e">ls</span><span class="token" style="color:#4a5f78">(</span><span>argv</span><span class="token" style="color:#4a5f78">[</span><span>i</span><span class="token" style="color:#4a5f78">]</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">;</span><span>
</span>
<span>  </span><span class="token" style="color:#57718e">exit</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#0aa370">0</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">;</span><span>
</span><span></span><span class="token" style="color:#4a5f78">}</span><span>
</span>
</code></pre><div class="break-words ..."><p>最初っぽいので ls にしました。</p>
<p>GNU とか BSD のは記述量とか多そうだったので教育用に作られた Linux である<a href="https://pdos.csail.mit.edu/6.828/2012/xv6.html">xv6</a>のなかの ls を読んでみます。</p>
<p>ちなみに私の C 言語レベルは<a href="https://amzn.to/35Nc5Bn">詳説 C ポインタ</a>を読んで理解したというレベルです。</p>
<h1>Repository</h1>
<p><a href="https://github.com/mit-pdos/xv6-riscv">github.com/mit-pdos/xv6-riscv</a></p>
<p>(<a href="https://github.com/mit-pdos/xv6-public">github.com/mit-pdos/xv6-public</a></p>
<p>はもうメンテナンスされていないらしいです。)</p>
<h2>ls</h2>
<p><a href="https://github.com/mit-pdos/xv6-riscv/blob/riscv/user/ls.c">対象コード</a></p>
<h2>Reading</h2>
<h3>main function</h3>
<pre><code class="hljs language-c"><span class="hljs-function"><span class="hljs-keyword">int</span>
<span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
  <span class="hljs-keyword">int</span> i;

  <span class="hljs-keyword">if</span>(argc &#x3C; <span class="hljs-number">2</span>){
    ls(<span class="hljs-string">"."</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
  }
  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>; i&#x3C;argc; i++)
    ls(argv[i]);
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}</code></pre>
<p>main 関数はシンプルです。</p>
<p>コマンドの引数がない場合、ls 関数の引数として current directory を渡します。</p>
<p>コマンドの引数がある場合、順番に ls 関数の引数としてコマンドの引数を渡します。</p>
<h2>ls function</h2>
<pre><code class="hljs language-c"><span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">ls</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *path)</span>
</span>{
  <span class="hljs-keyword">char</span> buf[<span class="hljs-number">512</span>], *p;
  <span class="hljs-keyword">int</span> fd;
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> <span class="hljs-title">de</span>;</span>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span>

  <span class="hljs-comment">// #1</span>
  <span class="hljs-keyword">if</span>((fd = open(path, <span class="hljs-number">0</span>)) &#x3C; <span class="hljs-number">0</span>){
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"ls: cannot open %s\n"</span>, path);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// #2</span>
  <span class="hljs-keyword">if</span>(fstat(fd, &#x26;st) &#x3C; <span class="hljs-number">0</span>){
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"ls: cannot stat %s\n"</span>, path);
    close(fd);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// #3</span>
  <span class="hljs-keyword">switch</span>(st.type){
  <span class="hljs-keyword">case</span> T_FILE:
    <span class="hljs-comment">// #4</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s %d %d %l\n"</span>, fmtname(path), st.type, st.ino, st.size);
    <span class="hljs-keyword">break</span>;

  <span class="hljs-keyword">case</span> T_DIR:
    <span class="hljs-comment">// #5</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strlen</span>(path) + <span class="hljs-number">1</span> + DIRSIZ + <span class="hljs-number">1</span> > <span class="hljs-keyword">sizeof</span> buf){
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ls: path too long\n"</span>);
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-built_in">strcpy</span>(buf, path);
    p = buf+<span class="hljs-built_in">strlen</span>(buf);
    *p++ = <span class="hljs-string">'/'</span>;
    <span class="hljs-comment">// #6</span>
    <span class="hljs-keyword">while</span>(read(fd, &#x26;de, <span class="hljs-keyword">sizeof</span>(de)) == <span class="hljs-keyword">sizeof</span>(de)){
      <span class="hljs-keyword">if</span>(de.inum == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">continue</span>;
      memmove(p, de.name, DIRSIZ);
      p[DIRSIZ] = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span>(stat(buf, &#x26;st) &#x3C; <span class="hljs-number">0</span>){
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ls: cannot stat %s\n"</span>, buf);
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-comment">// #7</span>
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s %d %d %d\n"</span>, fmtname(buf), st.type, st.ino, st.size);
    }
    <span class="hljs-keyword">break</span>;
  }
  close(fd);
}</code></pre>
<p>流れはざっとこんなもん</p>
<ul>
<li>
<p>#1 パスをオープン</p>
</li>
<li>
<p>#2 パスの情報取得</p>
</li>
<li>
<p>#3 パスのタイプによって分岐</p>
</li>
<li>
<p>#4 ファイルであれば、出力</p>
</li>
<li>
<p>#5 ディレクトリの場合</p>
</li>
<li>
<p>#6 ディレクトリ内のファイルをあるだけ読み込む</p>
</li>
<li>
<p>#7 出力</p>
</li>
</ul>
<h1>Rewrite</h1>
<p>すべて自作の関数のため、一つ一つ見ていくのは時間がかかるので c11 で書き直してみました。</p>
<p><a href="https://github.com/the-coding-dead/code/blob/main/xv6-ls/myls.c">myls</a></p>
<pre><code class="hljs language-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ls</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *path)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span>

  <span class="hljs-keyword">if</span> (stat(path, &#x26;st) &#x3C; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ls: cannot stat %s\n"</span>, path);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">if</span> (S_ISREG(st.st_mode)) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s %d %lu %ld\n"</span>, fmtname(path), st.st_mode, st.st_ino, st.st_size);
  }

  <span class="hljs-comment">// #1</span>
  <span class="hljs-keyword">if</span> (S_ISDIR(st.st_mode)) {
    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">512</span>];
    <span class="hljs-comment">// #2</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(path) + <span class="hljs-number">1</span> + DIRSIZ + <span class="hljs-number">1</span> > <span class="hljs-keyword">sizeof</span> buf) {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ls: path too long\n"</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// #3</span>
    <span class="hljs-built_in">strcpy</span>(buf, path);
    <span class="hljs-keyword">char</span> *p = buf + <span class="hljs-built_in">strlen</span>(buf);
    *p++ = <span class="hljs-string">'/'</span>;

    <span class="hljs-comment">// #4</span>
    DIR *dir = opendir(path);
    <span class="hljs-keyword">for</span> (struct dirent *de = readdir(dir); de != <span class="hljs-literal">NULL</span>; de = readdir(dir)) {
      <span class="hljs-comment">// #5</span>
      memmove(p, de->d_name, DIRSIZ);
      p[DIRSIZ] = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">if</span> (stat(buf, &#x26;st) &#x3C; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ls: cannot stat %s\n"</span>, buf);
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-comment">// #6</span>
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s %d %lu %ld\n"</span>, fmtname(buf), st.st_mode, st.st_ino,
             st.st_size);
    }
  }
}</code></pre>
<p>やはり、少し短くなってる！</p>
<p>多分もう少し短く書けると思います。(fmtname 関数はそのまま使用)</p>
<ul>
<li>
<p>#1 のディレクトリを対象とした処理はいつもほぼ c を読んでいないためかなり手こずりました</p>
</li>
<li>
<p>#2 ここは普段可変長の配列を使っているとほとんど意識しないような処理</p>
<ul>
<li>malloc とかで動的に長さを設定できるようにしても良いかもしれない</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-c"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(path) + <span class="hljs-number">1</span> + DIRSIZ + <span class="hljs-number">1</span> > <span class="hljs-keyword">sizeof</span> buf) {
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ls: path too long\n"</span>);
  <span class="hljs-keyword">return</span>;
}</code></pre>
<ul>
<li>#3 こういう配列をポインタで操作してくのは久しぶりに c やるとよくわかんなくなるなあ
<ul>
<li>buf はディレクトリとファイル名を<code>/</code>でつなげたものを格納する場所</li>
<li>p は格納していく際に一番後ろのメモリの位置を指すカーソルとして使用する</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-c"><span class="hljs-built_in">strcpy</span>(buf, path);
<span class="hljs-keyword">char</span> *p = buf + <span class="hljs-built_in">strlen</span>(buf);
*p++ = <span class="hljs-string">'/'</span>;</code></pre>
<ul>
<li>#4 directory のなかのファイルを一覧していく</li>
</ul>
<pre><code class="hljs language-c">DIR *dir = opendir(path);
<span class="hljs-keyword">for</span> (struct dirent *de = readdir(dir); de != <span class="hljs-literal">NULL</span>; de = readdir(dir)) {</code></pre>
<ul>
<li>#5 p にファイル名をコピーして、終端 null 文字を最後に入れる(<code>'\0'</code>を入れるのと同じ)</li>
</ul>
<pre><code class="hljs language-c">memmove(p, de->d_name, DIRSIZ);
p[DIRSIZ] = <span class="hljs-number">0</span>;</code></pre>
<ul>
<li>#6 出力
<ul>
<li>verb の数が多すぎて大変だなあ</li>
<li>go は楽で良い</li>
<li>使いたいときだけ複雑なものを使用すれば良いから</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-c"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s %d %lu %ld\n"</span>, fmtname(buf), st.st_mode, st.st_ino,
       st.st_size);</code></pre>
<h2>Conclusion</h2>
<p>久しぶりに c のコードを読んだけど時間かかりました。。。</p>
<p>やってることは単純だけどポインタの動きを追いながら読むのは勉強になります。</p>
<p>ただ、書き直すのを毎日やるのはちょっともう無理かもです。</p>
<p>次は Go か Python にしとこうかな。</p>
</div></article></main></div><footer class="container mx-auto pb-5 text-center">The Coding Dead. All rights reserved.</footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"xv6-ls","code":"int main(int argc, char *argv[]) {\n  if (argc \u003c 2) {\n    ls(\".\");\n    exit(0);\n  }\n\n  for (int i = 1; i \u003c argc; i++)\n    ls(argv[i]);\n\n  exit(0);\n}\n","language":"c","contentHtml":"\u003cp\u003e最初っぽいので ls にしました。\u003c/p\u003e\n\u003cp\u003eGNU とか BSD のは記述量とか多そうだったので教育用に作られた Linux である\u003ca href=\"https://pdos.csail.mit.edu/6.828/2012/xv6.html\"\u003exv6\u003c/a\u003eのなかの ls を読んでみます。\u003c/p\u003e\n\u003cp\u003eちなみに私の C 言語レベルは\u003ca href=\"https://amzn.to/35Nc5Bn\"\u003e詳説 C ポインタ\u003c/a\u003eを読んで理解したというレベルです。\u003c/p\u003e\n\u003ch1\u003eRepository\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/mit-pdos/xv6-riscv\"\u003egithub.com/mit-pdos/xv6-riscv\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e(\u003ca href=\"https://github.com/mit-pdos/xv6-public\"\u003egithub.com/mit-pdos/xv6-public\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eはもうメンテナンスされていないらしいです。)\u003c/p\u003e\n\u003ch2\u003els\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/mit-pdos/xv6-riscv/blob/riscv/user/ls.c\"\u003e対象コード\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eReading\u003c/h2\u003e\n\u003ch3\u003emain function\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eint\u003c/span\u003e\n\u003cspan class=\"hljs-title\"\u003emain\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-keyword\"\u003eint\u003c/span\u003e argc, \u003cspan class=\"hljs-keyword\"\u003echar\u003c/span\u003e *argv[])\u003c/span\u003e\n\u003c/span\u003e{\n  \u003cspan class=\"hljs-keyword\"\u003eint\u003c/span\u003e i;\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(argc \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e){\n    ls(\u003cspan class=\"hljs-string\"\u003e\".\"\u003c/span\u003e);\n    \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\n  }\n  \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e(i=\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e; i\u0026#x3C;argc; i++)\n    ls(argv[i]);\n  \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\n}\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003emain 関数はシンプルです。\u003c/p\u003e\n\u003cp\u003eコマンドの引数がない場合、ls 関数の引数として current directory を渡します。\u003c/p\u003e\n\u003cp\u003eコマンドの引数がある場合、順番に ls 関数の引数としてコマンドの引数を渡します。\u003c/p\u003e\n\u003ch2\u003els function\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e\n\u003cspan class=\"hljs-title\"\u003els\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-keyword\"\u003echar\u003c/span\u003e *path)\u003c/span\u003e\n\u003c/span\u003e{\n  \u003cspan class=\"hljs-keyword\"\u003echar\u003c/span\u003e buf[\u003cspan class=\"hljs-number\"\u003e512\u003c/span\u003e], *p;\n  \u003cspan class=\"hljs-keyword\"\u003eint\u003c/span\u003e fd;\n  \u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003edirent\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ede\u003c/span\u003e;\u003c/span\u003e\n  \u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003estat\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003est\u003c/span\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"hljs-comment\"\u003e// #1\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e((fd = open(path, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)) \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e){\n    \u003cspan class=\"hljs-built_in\"\u003efprintf\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"ls: cannot open %s\\n\"\u003c/span\u003e, path);\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n  }\n\n  \u003cspan class=\"hljs-comment\"\u003e// #2\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(fstat(fd, \u0026#x26;st) \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e){\n    \u003cspan class=\"hljs-built_in\"\u003efprintf\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"ls: cannot stat %s\\n\"\u003c/span\u003e, path);\n    close(fd);\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n  }\n\n  \u003cspan class=\"hljs-comment\"\u003e// #3\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e(st.type){\n  \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e T_FILE:\n    \u003cspan class=\"hljs-comment\"\u003e// #4\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"%s %d %d %l\\n\"\u003c/span\u003e, fmtname(path), st.type, st.ino, st.size);\n    \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n\n  \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e T_DIR:\n    \u003cspan class=\"hljs-comment\"\u003e// #5\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(\u003cspan class=\"hljs-built_in\"\u003estrlen\u003c/span\u003e(path) + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e + DIRSIZ + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003e \u003cspan class=\"hljs-keyword\"\u003esizeof\u003c/span\u003e buf){\n      \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"ls: path too long\\n\"\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n    }\n    \u003cspan class=\"hljs-built_in\"\u003estrcpy\u003c/span\u003e(buf, path);\n    p = buf+\u003cspan class=\"hljs-built_in\"\u003estrlen\u003c/span\u003e(buf);\n    *p++ = \u003cspan class=\"hljs-string\"\u003e'/'\u003c/span\u003e;\n    \u003cspan class=\"hljs-comment\"\u003e// #6\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e(read(fd, \u0026#x26;de, \u003cspan class=\"hljs-keyword\"\u003esizeof\u003c/span\u003e(de)) == \u003cspan class=\"hljs-keyword\"\u003esizeof\u003c/span\u003e(de)){\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(de.inum == \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e)\n        \u003cspan class=\"hljs-keyword\"\u003econtinue\u003c/span\u003e;\n      memmove(p, de.name, DIRSIZ);\n      p[DIRSIZ] = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(stat(buf, \u0026#x26;st) \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e){\n        \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"ls: cannot stat %s\\n\"\u003c/span\u003e, buf);\n        \u003cspan class=\"hljs-keyword\"\u003econtinue\u003c/span\u003e;\n      }\n      \u003cspan class=\"hljs-comment\"\u003e// #7\u003c/span\u003e\n      \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"%s %d %d %d\\n\"\u003c/span\u003e, fmtname(buf), st.type, st.ino, st.size);\n    }\n    \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n  }\n  close(fd);\n}\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e流れはざっとこんなもん\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e#1 パスをオープン\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e#2 パスの情報取得\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e#3 パスのタイプによって分岐\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e#4 ファイルであれば、出力\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e#5 ディレクトリの場合\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e#6 ディレクトリ内のファイルをあるだけ読み込む\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e#7 出力\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eRewrite\u003c/h1\u003e\n\u003cp\u003eすべて自作の関数のため、一つ一つ見ていくのは時間がかかるので c11 で書き直してみました。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/the-coding-dead/code/blob/main/xv6-ls/myls.c\"\u003emyls\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003els\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(\u003cspan class=\"hljs-keyword\"\u003echar\u003c/span\u003e *path)\u003c/span\u003e \u003c/span\u003e{\n  \u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003estat\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003est\u003c/span\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (stat(path, \u0026#x26;st) \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\n    \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"ls: cannot stat %s\\n\"\u003c/span\u003e, path);\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (S_ISREG(st.st_mode)) {\n    \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"%s %d %lu %ld\\n\"\u003c/span\u003e, fmtname(path), st.st_mode, st.st_ino, st.st_size);\n  }\n\n  \u003cspan class=\"hljs-comment\"\u003e// #1\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (S_ISDIR(st.st_mode)) {\n    \u003cspan class=\"hljs-keyword\"\u003echar\u003c/span\u003e buf[\u003cspan class=\"hljs-number\"\u003e512\u003c/span\u003e];\n    \u003cspan class=\"hljs-comment\"\u003e// #2\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003estrlen\u003c/span\u003e(path) + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e + DIRSIZ + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003e \u003cspan class=\"hljs-keyword\"\u003esizeof\u003c/span\u003e buf) {\n      \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"ls: path too long\\n\"\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n    }\n\n    \u003cspan class=\"hljs-comment\"\u003e// #3\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003estrcpy\u003c/span\u003e(buf, path);\n    \u003cspan class=\"hljs-keyword\"\u003echar\u003c/span\u003e *p = buf + \u003cspan class=\"hljs-built_in\"\u003estrlen\u003c/span\u003e(buf);\n    *p++ = \u003cspan class=\"hljs-string\"\u003e'/'\u003c/span\u003e;\n\n    \u003cspan class=\"hljs-comment\"\u003e// #4\u003c/span\u003e\n    DIR *dir = opendir(path);\n    \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (struct dirent *de = readdir(dir); de != \u003cspan class=\"hljs-literal\"\u003eNULL\u003c/span\u003e; de = readdir(dir)) {\n      \u003cspan class=\"hljs-comment\"\u003e// #5\u003c/span\u003e\n      memmove(p, de-\u003ed_name, DIRSIZ);\n      p[DIRSIZ] = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (stat(buf, \u0026#x26;st) \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\n        \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"ls: cannot stat %s\\n\"\u003c/span\u003e, buf);\n        \u003cspan class=\"hljs-keyword\"\u003econtinue\u003c/span\u003e;\n      }\n      \u003cspan class=\"hljs-comment\"\u003e// #6\u003c/span\u003e\n      \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"%s %d %lu %ld\\n\"\u003c/span\u003e, fmtname(buf), st.st_mode, st.st_ino,\n             st.st_size);\n    }\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eやはり、少し短くなってる！\u003c/p\u003e\n\u003cp\u003e多分もう少し短く書けると思います。(fmtname 関数はそのまま使用)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e#1 のディレクトリを対象とした処理はいつもほぼ c を読んでいないためかなり手こずりました\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e#2 ここは普段可変長の配列を使っているとほとんど意識しないような処理\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003emalloc とかで動的に長さを設定できるようにしても良いかもしれない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-built_in\"\u003estrlen\u003c/span\u003e(path) + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e + DIRSIZ + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003e \u003cspan class=\"hljs-keyword\"\u003esizeof\u003c/span\u003e buf) {\n  \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"ls: path too long\\n\"\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n}\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e#3 こういう配列をポインタで操作してくのは久しぶりに c やるとよくわかんなくなるなあ\n\u003cul\u003e\n\u003cli\u003ebuf はディレクトリとファイル名を\u003ccode\u003e/\u003c/code\u003eでつなげたものを格納する場所\u003c/li\u003e\n\u003cli\u003ep は格納していく際に一番後ろのメモリの位置を指すカーソルとして使用する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003e\u003cspan class=\"hljs-built_in\"\u003estrcpy\u003c/span\u003e(buf, path);\n\u003cspan class=\"hljs-keyword\"\u003echar\u003c/span\u003e *p = buf + \u003cspan class=\"hljs-built_in\"\u003estrlen\u003c/span\u003e(buf);\n*p++ = \u003cspan class=\"hljs-string\"\u003e'/'\u003c/span\u003e;\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e#4 directory のなかのファイルを一覧していく\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003eDIR *dir = opendir(path);\n\u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (struct dirent *de = readdir(dir); de != \u003cspan class=\"hljs-literal\"\u003eNULL\u003c/span\u003e; de = readdir(dir)) {\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e#5 p にファイル名をコピーして、終端 null 文字を最後に入れる(\u003ccode\u003e'\\0'\u003c/code\u003eを入れるのと同じ)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003ememmove(p, de-\u003ed_name, DIRSIZ);\np[DIRSIZ] = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e#6 出力\n\u003cul\u003e\n\u003cli\u003everb の数が多すぎて大変だなあ\u003c/li\u003e\n\u003cli\u003ego は楽で良い\u003c/li\u003e\n\u003cli\u003e使いたいときだけ複雑なものを使用すれば良いから\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-c\"\u003e\u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"%s %d %lu %ld\\n\"\u003c/span\u003e, fmtname(buf), st.st_mode, st.st_ino,\n       st.st_size);\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003e久しぶりに c のコードを読んだけど時間かかりました。。。\u003c/p\u003e\n\u003cp\u003eやってることは単純だけどポインタの動きを追いながら読むのは勉強になります。\u003c/p\u003e\n\u003cp\u003eただ、書き直すのを毎日やるのはちょっともう無理かもです。\u003c/p\u003e\n\u003cp\u003e次は Go か Python にしとこうかな。\u003c/p\u003e\n","title":"xv6 - ls","date":"2021-01-16","description":"今日は最初ということで教育用のlinuxのlsを読みます。"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"xv6-ls"},"buildId":"OhsLwgugMF1EztRcaCemC","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-86038f8325ecf14c2308.js"></script><script src="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-88fadddb26c5e799d42f.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.c645823ab151cf7b449d.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-56b0fb255e18ef8fb0ae.js" async=""></script><script src="/_next/static/OhsLwgugMF1EztRcaCemC/_buildManifest.js" async=""></script><script src="/_next/static/OhsLwgugMF1EztRcaCemC/_ssgManifest.js" async=""></script></body></html>