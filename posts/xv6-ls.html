<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>The Coding Dead | xv6 - ls</title><link rel="icon" href="/favicon.ico"/><meta name="description" content="今日は最初ということで教育用のlinuxのlsを読みます。"/><meta property="og:image" content="https://raw.githubusercontent.com/the-coding-dead/the-coding-dead.github.io/main/public/images/og-image.png"/><meta name="og:title" content="The Coding Dead | xv6 - ls"/><meta name="og:description" content="今日は最初ということで教育用のlinuxのlsを読みます。"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/1512ed6be54ee67cb89b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1512ed6be54ee67cb89b.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-b97d4bc729abe1e5ffe1.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.104b3985dfefd187c77d.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-d68bf9e24d3029906894.js" as="script"/></head><body><div id="__next"><div class="container h-screen flex flex-col min-h-screen"><div class="bg-gray-800 h-auto w-screen p-3"><div class="cursor-pointer hover:opacity-75"><div><p class="text-3xl font-bold mb-2">The Coding Dead</p><p class="text-xs">窒息するほどコードを読んで<br/>スーパーエンジニアになった気になる</p></div></div></div><div class="container mx-2 px-4 mx-auto flex-grow"><main><article class="relative container mt-5 p-3 bg-gray-600 rounded"><div class="absolute top-2 right-2 bg-gray-700 h-4 w-4 rounded-full"></div><h1 class="text-3xl mb-1">xv6 - ls</h1><time dateTime="2021-01-16">January 16, 2021</time><pre class="my-0 p-0" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e;padding:1em;margin:.5em 0;overflow:auto"><code class="language-c" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e"><span class="token" style="color:#47ebb4">int</span><span> </span><span class="token" style="color:#57718e">main</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">int</span><span> argc</span><span class="token" style="color:#4a5f78">,</span><span> </span><span class="token" style="color:#47ebb4">char</span><span> </span><span class="token" style="color:#0aa370">*</span><span>argv</span><span class="token" style="color:#4a5f78">[</span><span class="token" style="color:#4a5f78">]</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span>
</span><span>  </span><span class="token" style="color:#47ebb4">if</span><span> </span><span class="token" style="color:#4a5f78">(</span><span>argc </span><span class="token" style="color:#0aa370">&lt;</span><span> </span><span class="token" style="color:#0aa370">2</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span>
</span><span>    </span><span class="token" style="color:#57718e">ls</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;.&quot;</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">;</span><span>
</span><span>    </span><span class="token" style="color:#57718e">exit</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#0aa370">0</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">;</span><span>
</span><span>  </span><span class="token" style="color:#4a5f78">}</span><span>
</span>
<span>  </span><span class="token" style="color:#47ebb4">for</span><span> </span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">int</span><span> i </span><span class="token" style="color:#0aa370">=</span><span> </span><span class="token" style="color:#0aa370">1</span><span class="token" style="color:#4a5f78">;</span><span> i </span><span class="token" style="color:#0aa370">&lt;</span><span> argc</span><span class="token" style="color:#4a5f78">;</span><span> i</span><span class="token" style="color:#0aa370">++</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span>    </span><span class="token" style="color:#57718e">ls</span><span class="token" style="color:#4a5f78">(</span><span>argv</span><span class="token" style="color:#4a5f78">[</span><span>i</span><span class="token" style="color:#4a5f78">]</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">;</span><span>
</span>
<span>  </span><span class="token" style="color:#57718e">exit</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#0aa370">0</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">;</span><span>
</span><span></span><span class="token" style="color:#4a5f78">}</span><span>
</span>
</code></pre><div class="break-words"><p>最初っぽいので ls にしました。</p>
<p>GNU とか BSD のは記述量とか多そうだったので教育用に作られた Linux である<a href="https://pdos.csail.mit.edu/6.828/2012/xv6.html">xv6</a>のなかの ls を読んでみます。</p>
<p>ちなみに私の C 言語のレベルは<a href="https://amzn.to/35Nc5Bn">詳説 C ポインタ</a>を読んで理解したというレベルです。読めるけど書けないというやつです。</p>
<h1>Repository</h1>
<p><a href="https://github.com/mit-pdos/xv6-riscv">github.com/mit-pdos/xv6-riscv</a></p>
<p>ちなみに</p>
<p><a href="https://github.com/mit-pdos/xv6-public">github.com/mit-pdos/xv6-public</a>はもうメンテナンスされていないらしいです。</p>
<h2>ls</h2>
<p>コード: <a href="https://github.com/mit-pdos/xv6-riscv/blob/riscv/user/ls.c">ls.c</a></p>
<h2>Reading</h2>
<h3>main function</h3>
<div class="remark-highlight"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&#x3C;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">ls</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&#x3C;</span>argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">ls</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>main 関数はシンプルです。</p>
<p>コマンドの引数がない場合、ls 関数の引数として current directory を渡します。</p>
<p>コマンドの引数がある場合、順番に ls 関数の引数としてコマンドの引数を渡します。</p>
<h2>ls function</h2>
<div class="remark-highlight"><pre class="language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">ls</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">dirent</span> de<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>

  <span class="token comment">// 1</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"ls: cannot open %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&#x26;</span>st<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"ls: cannot stat %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">case</span> T_FILE<span class="token operator">:</span>
    <span class="token comment">// 4</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %d %d %l\n"</span><span class="token punctuation">,</span> <span class="token function">fmtname</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>type<span class="token punctuation">,</span> st<span class="token punctuation">.</span>ino<span class="token punctuation">,</span> st<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> T_DIR<span class="token operator">:</span>
    <span class="token comment">// 5</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> DIRSIZ <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">></span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ls: path too long\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p <span class="token operator">=</span> buf<span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
    <span class="token comment">// 6</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&#x26;</span>de<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>de<span class="token punctuation">.</span>inum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> de<span class="token punctuation">.</span>name<span class="token punctuation">,</span> DIRSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
      p<span class="token punctuation">[</span>DIRSIZ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&#x26;</span>st<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ls: cannot stat %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 7</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %d %d %d\n"</span><span class="token punctuation">,</span> <span class="token function">fmtname</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>type<span class="token punctuation">,</span> st<span class="token punctuation">.</span>ino<span class="token punctuation">,</span> st<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>流れはざっとこんなもん</p>
<ul>
<li>1 パスをオープン</li>
<li>2 パスの情報取得</li>
<li>3 パスのタイプによって分岐</li>
<li>4 ファイルであれば、出力</li>
<li>5 ディレクトリの場合</li>
<li>6 ディレクトリ内のファイルをあるだけ読み込む</li>
<li>7 出力</li>
</ul>
<h1>Rewrite</h1>
<p>すべて自作の関数のため、一つ一つ見ていくのは時間がかかるので C11 で書き直してみました。</p>
<p>コード: <a href="https://github.com/the-coding-dead/code/blob/main/xv6-ls/myls.c">myls</a></p>
<div class="remark-highlight"><pre class="language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ls</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">&#x26;</span>st<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ls: cannot stat %s\n"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %d %lu %ld\n"</span><span class="token punctuation">,</span> <span class="token function">fmtname</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_mode<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_ino<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">S_ISDIR</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 2</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> DIRSIZ <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">></span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ls: path too long\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> buf <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>

    <span class="token comment">// 4</span>
    DIR <span class="token operator">*</span>dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>de <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span> de <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> de <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 5</span>
      <span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> de<span class="token operator">-></span>d_name<span class="token punctuation">,</span> DIRSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
      p<span class="token punctuation">[</span>DIRSIZ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token operator">&#x26;</span>st<span class="token punctuation">)</span> <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ls: cannot stat %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 6</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %d %lu %ld\n"</span><span class="token punctuation">,</span> <span class="token function">fmtname</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_mode<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_ino<span class="token punctuation">,</span>
             st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>やはり、少し短くなってる！</p>
<p>多分もう少し短く書けると思います。(fmtname 関数はそのまま使用)</p>
<ul>
<li>
<p>1 のディレクトリを対象とした処理はいつもほぼ C を読んでいないためかなり手こずりました</p>
</li>
<li>
<p>2 ここは普段可変長の配列を使っているとほとんど意識しないような処理</p>
<ul>
<li>malloc とかで動的に長さを設定できるようにしても良いかもしれない</li>
</ul>
</li>
</ul>
<div class="remark-highlight"><pre class="language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> DIRSIZ <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">></span> <span class="token keyword">sizeof</span> buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ls: path too long\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<ul>
<li>3 こういう配列をポインタで操作してくのは久しぶりに C やるとよくわかんなくなるなあ
<ul>
<li>buf はディレクトリとファイル名を<code>/</code>でつなげたものを格納する場所</li>
<li>p は格納していく際に一番後ろのメモリの位置を指すカーソルとして使用する</li>
</ul>
</li>
</ul>
<div class="remark-highlight"><pre class="language-c"><code class="language-c"><span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> buf <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
</code></pre></div>
<ul>
<li>4 directory のなかのファイルを一覧していく</li>
</ul>
<div class="remark-highlight"><pre class="language-c"><code class="language-c">DIR <span class="token operator">*</span>dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>de <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span> de <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> de <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre></div>
<ul>
<li>5 p にファイル名をコピーして、終端 null 文字を最後に入れる(<code>'\0'</code>を入れるのと同じ)</li>
</ul>
<div class="remark-highlight"><pre class="language-c"><code class="language-c"><span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> de<span class="token operator">-></span>d_name<span class="token punctuation">,</span> DIRSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">[</span>DIRSIZ<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></div>
<ul>
<li>6 出力
<ul>
<li>verb の数が多すぎて大変だなあ</li>
<li>Go は楽で良い</li>
<li>使いたいときだけ複雑なものを使用すれば良いから</li>
</ul>
</li>
</ul>
<div class="remark-highlight"><pre class="language-c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %d %lu %ld\n"</span><span class="token punctuation">,</span> <span class="token function">fmtname</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_mode<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_ino<span class="token punctuation">,</span>
       st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<h2>Conclusion</h2>
<p>久しぶりに C のコードを読んだけど時間かかりました。。。</p>
<p>やってることは単純だけどポインタの動きを追いながら読むのは勉強になります。</p>
<p>ただ、書き直すのを毎日やるのはちょっともう無理かもです。</p>
<p>次は Go か Python にしとこうかな。</p>
<p>以上です。</p>
</div></article></main></div><footer class="container mx-auto pb-5 text-center">The Coding Dead written by<!-- --> <a href="https://github.com/nasjp">nasjp</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"xv6-ls","code":"int main(int argc, char *argv[]) {\n  if (argc \u003c 2) {\n    ls(\".\");\n    exit(0);\n  }\n\n  for (int i = 1; i \u003c argc; i++)\n    ls(argv[i]);\n\n  exit(0);\n}\n","language":"c","contentHtml":"\u003cp\u003e最初っぽいので ls にしました。\u003c/p\u003e\n\u003cp\u003eGNU とか BSD のは記述量とか多そうだったので教育用に作られた Linux である\u003ca href=\"https://pdos.csail.mit.edu/6.828/2012/xv6.html\"\u003exv6\u003c/a\u003eのなかの ls を読んでみます。\u003c/p\u003e\n\u003cp\u003eちなみに私の C 言語のレベルは\u003ca href=\"https://amzn.to/35Nc5Bn\"\u003e詳説 C ポインタ\u003c/a\u003eを読んで理解したというレベルです。読めるけど書けないというやつです。\u003c/p\u003e\n\u003ch1\u003eRepository\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/mit-pdos/xv6-riscv\"\u003egithub.com/mit-pdos/xv6-riscv\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eちなみに\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/mit-pdos/xv6-public\"\u003egithub.com/mit-pdos/xv6-public\u003c/a\u003eはもうメンテナンスされていないらしいです。\u003c/p\u003e\n\u003ch2\u003els\u003c/h2\u003e\n\u003cp\u003eコード: \u003ca href=\"https://github.com/mit-pdos/xv6-riscv/blob/riscv/user/ls.c\"\u003els.c\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eReading\u003c/h2\u003e\n\u003ch3\u003emain function\u003c/h3\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e\n\u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e argc\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eargv\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eargc \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003els\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\".\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eexit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003eargc\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003els\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eargv\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003eexit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003emain 関数はシンプルです。\u003c/p\u003e\n\u003cp\u003eコマンドの引数がない場合、ls 関数の引数として current directory を渡します。\u003c/p\u003e\n\u003cp\u003eコマンドの引数がある場合、順番に ls 関数の引数としてコマンドの引数を渡します。\u003c/p\u003e\n\u003ch2\u003els function\u003c/h2\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e\n\u003cspan class=\"token function\"\u003els\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e buf\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e512\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ep\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e fd\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token class-name\"\u003edirent\u003c/span\u003e de\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token class-name\"\u003estat\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e// 1\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efd \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eopen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003efprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ls: cannot open %s\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e// 2\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003efstat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efd\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003est\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003efprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"ls: cannot stat %s\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eclose\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efd\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e// 3\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eswitch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003est\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etype\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e T_FILE\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 4\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"%s %d %d %l\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003efmtname\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etype\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eino\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esize\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e T_DIR\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 5\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003estrlen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e DIRSIZ \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token keyword\"\u003esizeof\u003c/span\u003e buf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ls: path too long\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003estrcpy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    p \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e buf\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token function\"\u003estrlen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ep\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 6\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eread\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efd\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003ede\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003esizeof\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ede\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token keyword\"\u003esizeof\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ede\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ede\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einum \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003ememmove\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ep\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e de\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e DIRSIZ\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      p\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eDIRSIZ\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003estat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003est\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ls: cannot stat %s\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e buf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// 7\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"%s %d %d %d\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003efmtname\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etype\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eino\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esize\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003eclose\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efd\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e流れはざっとこんなもん\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e1 パスをオープン\u003c/li\u003e\n\u003cli\u003e2 パスの情報取得\u003c/li\u003e\n\u003cli\u003e3 パスのタイプによって分岐\u003c/li\u003e\n\u003cli\u003e4 ファイルであれば、出力\u003c/li\u003e\n\u003cli\u003e5 ディレクトリの場合\u003c/li\u003e\n\u003cli\u003e6 ディレクトリ内のファイルをあるだけ読み込む\u003c/li\u003e\n\u003cli\u003e7 出力\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eRewrite\u003c/h1\u003e\n\u003cp\u003eすべて自作の関数のため、一つ一つ見ていくのは時間がかかるので C11 で書き直してみました。\u003c/p\u003e\n\u003cp\u003eコード: \u003ca href=\"https://github.com/the-coding-dead/code/blob/main/xv6-ls/myls.c\"\u003emyls\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003els\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token class-name\"\u003estat\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003estat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003est\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ls: cannot stat %s\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eS_ISREG\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003est\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_mode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"%s %d %lu %ld\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003efmtname\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_mode\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_ino\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_size\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  \u003cspan class=\"token comment\"\u003e// 1\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eS_ISDIR\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003est\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_mode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e buf\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e512\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 2\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003estrlen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e DIRSIZ \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token keyword\"\u003esizeof\u003c/span\u003e buf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ls: path too long\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 3\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003estrcpy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ep \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e buf \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token function\"\u003estrlen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ep\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 4\u003c/span\u003e\n    DIR \u003cspan class=\"token operator\"\u003e*\u003c/span\u003edir \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eopendir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token class-name\"\u003edirent\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ede \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ereaddir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edir\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e de \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eNULL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e de \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ereaddir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edir\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// 5\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003ememmove\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ep\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e de\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003ed_name\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e DIRSIZ\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      p\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eDIRSIZ\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003estat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003est\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ls: cannot stat %s\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e buf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// 6\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"%s %d %lu %ld\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003efmtname\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_mode\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_ino\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n             st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_size\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eやはり、少し短くなってる！\u003c/p\u003e\n\u003cp\u003e多分もう少し短く書けると思います。(fmtname 関数はそのまま使用)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e1 のディレクトリを対象とした処理はいつもほぼ C を読んでいないためかなり手こずりました\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e2 ここは普段可変長の配列を使っているとほとんど意識しないような処理\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003emalloc とかで動的に長さを設定できるようにしても良いかもしれない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003estrlen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e DIRSIZ \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token keyword\"\u003esizeof\u003c/span\u003e buf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"ls: path too long\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e3 こういう配列をポインタで操作してくのは久しぶりに C やるとよくわかんなくなるなあ\n\u003cul\u003e\n\u003cli\u003ebuf はディレクトリとファイル名を\u003ccode\u003e/\u003c/code\u003eでつなげたものを格納する場所\u003c/li\u003e\n\u003cli\u003ep は格納していく際に一番後ろのメモリの位置を指すカーソルとして使用する\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token function\"\u003estrcpy\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ep \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e buf \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token function\"\u003estrlen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e*\u003c/span\u003ep\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e4 directory のなかのファイルを一覧していく\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003eDIR \u003cspan class=\"token operator\"\u003e*\u003c/span\u003edir \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eopendir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"token class-name\"\u003edirent\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ede \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ereaddir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edir\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e de \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eNULL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e de \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ereaddir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edir\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e5 p にファイル名をコピーして、終端 null 文字を最後に入れる(\u003ccode\u003e'\\0'\u003c/code\u003eを入れるのと同じ)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token function\"\u003ememmove\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ep\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e de\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003ed_name\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e DIRSIZ\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\np\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eDIRSIZ\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e6 出力\n\u003cul\u003e\n\u003cli\u003everb の数が多すぎて大変だなあ\u003c/li\u003e\n\u003cli\u003eGo は楽で良い\u003c/li\u003e\n\u003cli\u003e使いたいときだけ複雑なものを使用すれば良いから\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token function\"\u003eprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"%s %d %lu %ld\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003efmtname\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuf\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_mode\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_ino\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n       st\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003est_size\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003e久しぶりに C のコードを読んだけど時間かかりました。。。\u003c/p\u003e\n\u003cp\u003eやってることは単純だけどポインタの動きを追いながら読むのは勉強になります。\u003c/p\u003e\n\u003cp\u003eただ、書き直すのを毎日やるのはちょっともう無理かもです。\u003c/p\u003e\n\u003cp\u003e次は Go か Python にしとこうかな。\u003c/p\u003e\n\u003cp\u003e以上です。\u003c/p\u003e\n","title":"xv6 - ls","date":"2021-01-16","description":"今日は最初ということで教育用のlinuxのlsを読みます。"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"xv6-ls"},"buildId":"yUSXwF6Vu9N-6nPJmUh84","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-86038f8325ecf14c2308.js"></script><script src="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-b97d4bc729abe1e5ffe1.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.104b3985dfefd187c77d.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-d68bf9e24d3029906894.js" async=""></script><script src="/_next/static/yUSXwF6Vu9N-6nPJmUh84/_buildManifest.js" async=""></script><script src="/_next/static/yUSXwF6Vu9N-6nPJmUh84/_ssgManifest.js" async=""></script></body></html>