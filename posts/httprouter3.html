<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>httprouter3 - The Coding Dead</title><link rel="icon" href="/favicon.ico"/><meta name="description" content="3回目！httprouterです。"/><meta property="og:image" content="https://raw.githubusercontent.com/the-coding-dead/the-coding-dead.github.io/main/public/images/og-image.png"/><meta name="og:title" content="httprouter3 - The Coding Dead"/><meta name="og:description" content="3回目！httprouterです。"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/b9772c72096ad1651865.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b9772c72096ad1651865.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-e13f5e753692f9663f23.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.73361561705e18283b5e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-a1b5a40e975a4b990753.js" as="script"/></head><body><div id="__next"><div class="bg-gray-800 h-auto w-screen p-3"><div class="cursor-pointer hover:opacity-75"><div><p class="text-3xl font-bold mb-2">The Coding Dead</p><p class="text-xs">窒息するほどコードを読んで<br/>スーパーエンジニアになった気になる</p></div></div></div><div class="container mx-auto"><div class="container h-screen flex flex-col"><div class="container px-2 flex-grow "><main><article class="relative container mt-5 p-3 bg-gray-600 rounded"><div class="absolute top-2 right-2 bg-gray-700 h-4 w-4 rounded-full"></div><h1 class="text-3xl mb-1">httprouter3</h1><div class="text-sm"><p>Related articles</p><ol><li><a href="httprouter">httprouter</a></li><li><a href="httprouter2">httprouter2</a></li><li><a href="httprouter3">この記事</a></li></ol></div><time dateTime="2021-01-25">January 25, 2021</time><pre class="my-0 p-0" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e;padding:1em;margin:.5em 0;overflow:auto"><code class="language-go" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e"><span class="token" style="color:#47ebb4">func</span><span> </span><span class="token" style="color:#57718e">main</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span>
</span><span>	router </span><span class="token" style="color:#0aa370">:=</span><span> httprouter</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">New</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span>	router</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">GET</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;/&quot;</span><span class="token" style="color:#4a5f78">,</span><span> Index</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span>	router</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">GET</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;/hello/:name&quot;</span><span class="token" style="color:#4a5f78">,</span><span> Hello</span><span class="token" style="color:#4a5f78">)</span><span>
</span>
<span>	log</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">Fatal</span><span class="token" style="color:#4a5f78">(</span><span>http</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">ListenAndServe</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">&quot;:8080&quot;</span><span class="token" style="color:#4a5f78">,</span><span> router</span><span class="token" style="color:#4a5f78">)</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span></span><span class="token" style="color:#4a5f78">}</span><span>
</span>
</code></pre><div><p>今回も引き続きGoの<a href="https://github.com/julienschmidt/httprouter">julienschmidt/httprouter</a>を読んでいきます！</p>
<h1>Review</h1>
<p>前回の復習</p>
<p><code>*node.insertChild</code>内で<code>Named paramters</code>と<code>Catch-All parameters</code>をどのように処理するのかを確認していきました。</p>
<p>今回は呼び出し元の<code>*node.addRoute</code>に戻って処理を読み進めていきます。</p>
<h1>Reading</h1>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fullPath <span class="token operator">:=</span> path
	n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

	<span class="token comment">// Empty tree</span>
	<span class="token keyword">if</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>indices <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>nType <span class="token operator">=</span> root
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

walk<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// Find the longest common prefix.</span>
		<span class="token comment">// This also implies that the common prefix contains no ':' or '*'</span>
		<span class="token comment">// since the existing key can't contain those chars.</span>
		i <span class="token operator">:=</span> <span class="token function">longestCommonPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

		<span class="token comment">// Split edge</span>
		<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			child <span class="token operator">:=</span> node<span class="token punctuation">{</span>
				path<span class="token punctuation">:</span>      n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				wildChild<span class="token punctuation">:</span> n<span class="token punctuation">.</span>wildChild<span class="token punctuation">,</span>
				nType<span class="token punctuation">:</span>     static<span class="token punctuation">,</span>
				indices<span class="token punctuation">:</span>   n<span class="token punctuation">.</span>indices<span class="token punctuation">,</span>
				children<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
				handle<span class="token punctuation">:</span>    n<span class="token punctuation">.</span>handle<span class="token punctuation">,</span>
				priority<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>priority <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span>

			n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span><span class="token operator">&#x26;</span>child<span class="token punctuation">}</span>
			<span class="token comment">// []byte for proper unicode char conversion, see #65</span>
			n<span class="token punctuation">.</span>indices <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
			n<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token boolean">nil</span>
			n<span class="token punctuation">.</span>wildChild <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Make new node a child of this node</span>
		<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			path <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>

			<span class="token keyword">if</span> n<span class="token punctuation">.</span>wildChild <span class="token punctuation">{</span>
				n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

				<span class="token comment">// Check if the wildcard matches</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&#x26;&#x26;</span>
					<span class="token comment">// Adding a child to a catchAll is not possible</span>
					n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token operator">&#x26;&#x26;</span>
					<span class="token comment">// Check for longer wildcard, e.g. :name and :names</span>
					<span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span> walk
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token comment">// Wildcard conflict</span>
					pathSeg <span class="token operator">:=</span> path
					<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token punctuation">{</span>
						pathSeg <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">SplitN</span><span class="token punctuation">(</span>pathSeg<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
					<span class="token punctuation">}</span>
					prefix <span class="token operator">:=</span> fullPath<span class="token punctuation">[</span><span class="token punctuation">:</span>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> pathSeg<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path
					<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"'"</span> <span class="token operator">+</span> pathSeg <span class="token operator">+</span>
						<span class="token string">"' in new path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span>
						<span class="token string">"' conflicts with existing wildcard '"</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path <span class="token operator">+</span>
						<span class="token string">"' in existing prefix '"</span> <span class="token operator">+</span> prefix <span class="token operator">+</span>
						<span class="token string">"'"</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			idxc <span class="token operator">:=</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

			<span class="token comment">// '/' after param</span>
			<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">==</span> param <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token operator">&#x26;&#x26;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
				n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
				n<span class="token punctuation">.</span>priority<span class="token operator">++</span>
				<span class="token keyword">continue</span> walk
			<span class="token punctuation">}</span>

			<span class="token comment">// Check if a child with the next path byte exists</span>
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> c <span class="token operator">==</span> idxc <span class="token punctuation">{</span>
					i <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
					n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
					<span class="token keyword">continue</span> walk
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Otherwise insert it</span>
			<span class="token keyword">if</span> idxc <span class="token operator">!=</span> <span class="token string">':'</span> <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">!=</span> <span class="token string">'*'</span> <span class="token punctuation">{</span>
				<span class="token comment">// []byte for proper unicode char conversion, see #65</span>
				n<span class="token punctuation">.</span>indices <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>idxc<span class="token punctuation">}</span><span class="token punctuation">)</span>
				child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span><span class="token punctuation">}</span>
				n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
				n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
				n <span class="token operator">=</span> child
			<span class="token punctuation">}</span>
			n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Otherwise add handle to current node</span>
		<span class="token keyword">if</span> n<span class="token punctuation">.</span>handle <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"a handle is already registered for path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		n<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> handle Handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fullPath <span class="token operator">:=</span> path
	n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

	<span class="token comment">// Empty tree</span>
	<span class="token keyword">if</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>indices <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>nType <span class="token operator">=</span> root
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
</code></pre></div>
<p>で前回は終わりました。</p>
<p>空のtreeではないときの処理である、以降コードを見ていきます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">walk<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// Find the longest common prefix.</span>
		<span class="token comment">// This also implies that the common prefix contains no ':' or '*'</span>
		<span class="token comment">// since the existing key can't contain those chars.</span>
		i <span class="token operator">:=</span> <span class="token function">longestCommonPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> n<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
</code></pre></div>
<p><code>/foo/bar/</code>と<code>/foo/baz/</code>の共通prefix<code>/foo/</code>のインデックスを取得する処理です。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Split edge</span>
<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  child <span class="token operator">:=</span> node<span class="token punctuation">{</span>
    path<span class="token punctuation">:</span>      n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    wildChild<span class="token punctuation">:</span> n<span class="token punctuation">.</span>wildChild<span class="token punctuation">,</span>
    nType<span class="token punctuation">:</span>     static<span class="token punctuation">,</span>
    indices<span class="token punctuation">:</span>   n<span class="token punctuation">.</span>indices<span class="token punctuation">,</span>
    children<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>children<span class="token punctuation">,</span>
    handle<span class="token punctuation">:</span>    n<span class="token punctuation">.</span>handle<span class="token punctuation">,</span>
    priority<span class="token punctuation">:</span>  n<span class="token punctuation">.</span>priority <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>node<span class="token punctuation">{</span><span class="token operator">&#x26;</span>child<span class="token punctuation">}</span>
  <span class="token comment">// []byte for proper unicode char conversion, see #65</span>
  n<span class="token punctuation">.</span>indices <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>n<span class="token punctuation">.</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  n<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span>
  n<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token boolean">nil</span>
  n<span class="token punctuation">.</span>wildChild <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>インデックスがノードのパスより短いとき、つまり</p>
<p><code>/foo/bar/baz</code>のようなノードに<code>/foo/bar</code>を追加するようなときの処理です。</p>
<p>単純に現在のノードの子ノードに割り込む形で登録しています。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Make new node a child of this node</span>
<span class="token keyword">if</span> i <span class="token operator">&#x3C;</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> n<span class="token punctuation">.</span>wildChild <span class="token punctuation">{</span>
    n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    n<span class="token punctuation">.</span>priority<span class="token operator">++</span>

    <span class="token comment">// Check if the wildcard matches</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&#x26;&#x26;</span> n<span class="token punctuation">.</span>path <span class="token operator">==</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">&#x26;&#x26;</span>
      <span class="token comment">// Adding a child to a catchAll is not possible</span>
      n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token operator">&#x26;&#x26;</span>
      <span class="token comment">// Check for longer wildcard, e.g. :name and :names</span>
      <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">||</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span> walk
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Wildcard conflict</span>
      pathSeg <span class="token operator">:=</span> path
      <span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">!=</span> catchAll <span class="token punctuation">{</span>
        pathSeg <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">SplitN</span><span class="token punctuation">(</span>pathSeg<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      prefix <span class="token operator">:=</span> fullPath<span class="token punctuation">[</span><span class="token punctuation">:</span>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> pathSeg<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path
      <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"'"</span> <span class="token operator">+</span> pathSeg <span class="token operator">+</span>
        <span class="token string">"' in new path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span>
        <span class="token string">"' conflicts with existing wildcard '"</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>path <span class="token operator">+</span>
        <span class="token string">"' in existing prefix '"</span> <span class="token operator">+</span> prefix <span class="token operator">+</span>
        <span class="token string">"'"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div>
<p>今度は逆で</p>
<p><code>/foo/bar</code>のようなノードに<code>/foo/bar/baz</code>を追加するようなときの処理です。</p>
<p><code>if n.wildChild { ... }</code> でワイルドカードのチェックをしています。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">idxc <span class="token operator">:=</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment">// '/' after param</span>
<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">==</span> param <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token operator">&#x26;&#x26;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
  n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  n<span class="token punctuation">.</span>priority<span class="token operator">++</span>
  <span class="token keyword">continue</span> walk
<span class="token punctuation">}</span>

<span class="token comment">// Check if a child with the next path byte exists</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> c <span class="token operator">==</span> idxc <span class="token punctuation">{</span>
    i <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">continue</span> walk
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Otherwise insert it</span>
<span class="token keyword">if</span> idxc <span class="token operator">!=</span> <span class="token string">':'</span> <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">!=</span> <span class="token string">'*'</span> <span class="token punctuation">{</span>
  <span class="token comment">// []byte for proper unicode char conversion, see #65</span>
  n<span class="token punctuation">.</span>indices <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>idxc<span class="token punctuation">}</span><span class="token punctuation">)</span>
  child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span><span class="token punctuation">}</span>
  n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
  n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
  n <span class="token operator">=</span> child
<span class="token punctuation">}</span>
n<span class="token punctuation">.</span><span class="token function">insertChild</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> handle<span class="token punctuation">)</span>
<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// '/' after param</span>
<span class="token keyword">if</span> n<span class="token punctuation">.</span>nType <span class="token operator">==</span> param <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token operator">&#x26;&#x26;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
  n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  n<span class="token punctuation">.</span>priority<span class="token operator">++</span>
  <span class="token keyword">continue</span> walk
<span class="token punctuation">}</span>
</code></pre></div>
<p>パラメータの直後だった場合は、現在ノードの子ノードを現在ノードとして、再度ループを回します。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Check if a child with the next path byte exists</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> c <span class="token operator">==</span> idxc <span class="token punctuation">{</span>
    i <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    n <span class="token operator">=</span> n<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">continue</span> walk
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>子ノードにパスの最初の文字と同じ文字を持つ子が存在するかどうかのチェックしています。</p>
<p>同じ場合は、その子ノードを現在のノードとして再度無限ループに戻ります</p>
<p>なぜ<code>n.indices</code>ループしているかというと</p>
<p>直後で子要素が複数ある場合はそれらを結合して保存しているためです。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// Otherwise insert it</span>
<span class="token keyword">if</span> idxc <span class="token operator">!=</span> <span class="token string">':'</span> <span class="token operator">&#x26;&#x26;</span> idxc <span class="token operator">!=</span> <span class="token string">'*'</span> <span class="token punctuation">{</span>
  <span class="token comment">// []byte for proper unicode char conversion, see #65</span>
  n<span class="token punctuation">.</span>indices <span class="token operator">+=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>idxc<span class="token punctuation">}</span><span class="token punctuation">)</span>
  child <span class="token operator">:=</span> <span class="token operator">&#x26;</span>node<span class="token punctuation">{</span><span class="token punctuation">}</span>
  n<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>children<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
  n<span class="token punctuation">.</span><span class="token function">incrementChildPrio</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
  n <span class="token operator">=</span> child
<span class="token punctuation">}</span>


<span class="token comment">// Otherwise add handle to current node</span>
<span class="token keyword">if</span> n<span class="token punctuation">.</span>handle <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"a handle is already registered for path '"</span> <span class="token operator">+</span> fullPath <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
n<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle
<span class="token keyword">return</span>
</code></pre></div>
<p>上記に該当しなければ、現在のノードに子ノードを追加し、<code>Handle</code>をノードに登録して終了です。</p>
<p>どうやって階層構造を作っているのかが全て理解できました！</p>
<p>では最後に<code>Handle</code>とパスの階層構造をもつ<code>*Router</code>を呼び出すかを確認していきます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Router<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>PanicHandler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> r<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	path <span class="token operator">:=</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path

	<span class="token keyword">if</span> root <span class="token operator">:=</span> r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>req<span class="token punctuation">.</span>Method<span class="token punctuation">]</span><span class="token punctuation">;</span> root <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> handle<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> tsr <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>getParams<span class="token punctuation">)</span><span class="token punctuation">;</span> handle <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> ps <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token function">handle</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token operator">*</span>ps<span class="token punctuation">)</span>
				r<span class="token punctuation">.</span><span class="token function">putParams</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">handle</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> req<span class="token punctuation">.</span>Method <span class="token operator">!=</span> http<span class="token punctuation">.</span>MethodConnect <span class="token operator">&#x26;&#x26;</span> path <span class="token operator">!=</span> <span class="token string">"/"</span> <span class="token punctuation">{</span>
			<span class="token comment">// Moved Permanently, request with GET method</span>
			code <span class="token operator">:=</span> http<span class="token punctuation">.</span>StatusMovedPermanently
			<span class="token keyword">if</span> req<span class="token punctuation">.</span>Method <span class="token operator">!=</span> http<span class="token punctuation">.</span>MethodGet <span class="token punctuation">{</span>
				<span class="token comment">// Permanent Redirect, request with same method</span>
				code <span class="token operator">=</span> http<span class="token punctuation">.</span>StatusPermanentRedirect
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> tsr <span class="token operator">&#x26;&#x26;</span> r<span class="token punctuation">.</span>RedirectTrailingSlash <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&#x26;&#x26;</span> path<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token punctuation">{</span>
					req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">"/"</span>
				<span class="token punctuation">}</span>
				http<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Try to fix the request path</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>RedirectFixedPath <span class="token punctuation">{</span>
				fixedPath<span class="token punctuation">,</span> found <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">findCaseInsensitivePath</span><span class="token punctuation">(</span>
					<span class="token function">CleanPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
					r<span class="token punctuation">.</span>RedirectTrailingSlash<span class="token punctuation">,</span>
				<span class="token punctuation">)</span>
				<span class="token keyword">if</span> found <span class="token punctuation">{</span>
					req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> fixedPath
					http<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> req<span class="token punctuation">.</span>Method <span class="token operator">==</span> http<span class="token punctuation">.</span>MethodOptions <span class="token operator">&#x26;&#x26;</span> r<span class="token punctuation">.</span>HandleOPTIONS <span class="token punctuation">{</span>
		<span class="token comment">// Handle OPTIONS requests</span>
		<span class="token keyword">if</span> allow <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">allowed</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> http<span class="token punctuation">.</span>MethodOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> allow <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Allow"</span><span class="token punctuation">,</span> allow<span class="token punctuation">)</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>GlobalOPTIONS <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				r<span class="token punctuation">.</span>GlobalOPTIONS<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> r<span class="token punctuation">.</span>HandleMethodNotAllowed <span class="token punctuation">{</span> <span class="token comment">// Handle 405</span>
		<span class="token keyword">if</span> allow <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">allowed</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">;</span> allow <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
			w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Allow"</span><span class="token punctuation">,</span> allow<span class="token punctuation">)</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>MethodNotAllowed <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				r<span class="token punctuation">.</span>MethodNotAllowed<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span>
					http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusMethodNotAllowed<span class="token punctuation">)</span><span class="token punctuation">,</span>
					http<span class="token punctuation">.</span>StatusMethodNotAllowed<span class="token punctuation">,</span>
				<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Handle 404</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>NotFound <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>NotFound<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		http<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>こっちはかなり読みやすいです。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">if</span> r<span class="token punctuation">.</span>PanicHandler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  <span class="token keyword">defer</span> r<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

path <span class="token operator">:=</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path

<span class="token keyword">if</span> root <span class="token operator">:=</span> r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>req<span class="token punctuation">.</span>Method<span class="token punctuation">]</span><span class="token punctuation">;</span> root <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">if</span> req<span class="token punctuation">.</span>Method <span class="token operator">==</span> http<span class="token punctuation">.</span>MethodOptions <span class="token operator">&#x26;&#x26;</span> r<span class="token punctuation">.</span>HandleOPTIONS <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> r<span class="token punctuation">.</span>HandleMethodNotAllowed <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token comment">// Handle 404</span>
<span class="token keyword">if</span> r<span class="token punctuation">.</span>NotFound <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  r<span class="token punctuation">.</span>NotFound<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  http<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>リクエストで受け取った<code>HTTPメソッド</code>が登録されておらず、</p>
<p><code>OPTIONS</code>でも<code>OPTIONS</code>設定が有効出ない場合は、</p>
<p><code>404</code>を返却します。</p>
<p>では下記を見ていきます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">if</span> root <span class="token operator">:=</span> r<span class="token punctuation">.</span>trees<span class="token punctuation">[</span>req<span class="token punctuation">.</span>Method<span class="token punctuation">]</span><span class="token punctuation">;</span> root <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> handle<span class="token punctuation">,</span> ps<span class="token punctuation">,</span> tsr <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> r<span class="token punctuation">.</span>getParams<span class="token punctuation">)</span><span class="token punctuation">;</span> handle <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> ps <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token function">handle</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token operator">*</span>ps<span class="token punctuation">)</span>
      r<span class="token punctuation">.</span><span class="token function">putParams</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">handle</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
</code></pre></div>
<p><code>*node.getValue</code>にすべて詰まっているようです。</p>
<p>今回はここまでにして、次回<code>*node.getValue</code>を見ます。</p>
<p>次回でラストにしよう。</p>
<h1>Conclusion</h1>
<p>ノードと子ノードの階層を作っている<code>*node.addRoute</code>を見てきました。</p>
<p>正直、自分でかんたんなものを作ってみないと完全には理解できないような気がします。</p>
<p>次回で絶対に終わらせたい！最初の方に扱う題材としては良かったのかなあ。</p>
<p>以上です。</p>
</div><div><h1 class="text-3xl mb-1">Related articles</h1><ol><li><a href="httprouter">httprouter</a></li><li><a href="httprouter2">httprouter2</a></li><li><a href="httprouter3">この記事</a></li></ol></div></article></main></div><footer class="container mx-auto pb-5 text-center">©<!-- --> <a href="https://github.com/the-coding-dead">github.com/the-coding-dead</a></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"httprouter3","code":"func main() {\n\trouter := httprouter.New()\n\trouter.GET(\"/\", Index)\n\trouter.GET(\"/hello/:name\", Hello)\n\n\tlog.Fatal(http.ListenAndServe(\":8080\", router))\n}\n","language":"go","contentHtml":"\u003cp\u003e今回も引き続きGoの\u003ca href=\"https://github.com/julienschmidt/httprouter\"\u003ejulienschmidt/httprouter\u003c/a\u003eを読んでいきます！\u003c/p\u003e\n\u003ch1\u003eReview\u003c/h1\u003e\n\u003cp\u003e前回の復習\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e*node.insertChild\u003c/code\u003e内で\u003ccode\u003eNamed paramters\u003c/code\u003eと\u003ccode\u003eCatch-All parameters\u003c/code\u003eをどのように処理するのかを確認していきました。\u003c/p\u003e\n\u003cp\u003e今回は呼び出し元の\u003ccode\u003e*node.addRoute\u003c/code\u003eに戻って処理を読み進めていきます。\u003c/p\u003e\n\u003ch1\u003eReading\u003c/h1\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en \u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eaddRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tfullPath \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Empty tree\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e root\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nwalk\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Find the longest common prefix.\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// This also implies that the common prefix contains no ':' or '*'\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// since the existing key can't contain those chars.\u003c/span\u003e\n\t\ti \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003elongestCommonPrefix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Split edge\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e node\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tpath\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e      n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\twildChild\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tnType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e     static\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tindices\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e   n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tchildren\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\thandle\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e    n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\tpriority\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Make new node a child of this node\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tpath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\t\t\t\u003cspan class=\"token comment\"\u003e// Check if the wildcard matches\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Adding a child to a catchAll is not possible\u003c/span\u003e\n\t\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e catchAll \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Check for longer wildcard, e.g. :name and :names\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token comment\"\u003e// Wildcard conflict\u003c/span\u003e\n\t\t\t\t\tpathSeg \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e catchAll \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\t\tpathSeg \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e strings\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSplitN\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epathSeg\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\t\tprefix \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003estrings\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIndex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e pathSeg\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\n\t\t\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e pathSeg \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' in new path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' conflicts with existing wildcard '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"' in existing prefix '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e prefix \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\tidxc \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// '/' after param\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e param \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// Check if a child with the next path byte exists\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erange\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token function\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e idxc \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\ti \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// Otherwise insert it\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'*'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eidxc\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tchild \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e child\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\u003cspan class=\"token comment\"\u003e// Otherwise add handle to current node\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"a handle is already registered for path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e handle\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en \u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eaddRoute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle Handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tfullPath \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Empty tree\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e root\n\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eで前回は終わりました。\u003c/p\u003e\n\u003cp\u003e空のtreeではないときの処理である、以降コードを見ていきます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003ewalk\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Find the longest common prefix.\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// This also implies that the common prefix contains no ':' or '*'\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// since the existing key can't contain those chars.\u003c/span\u003e\n\t\ti \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token function\"\u003elongestCommonPrefix\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003e/foo/bar/\u003c/code\u003eと\u003ccode\u003e/foo/baz/\u003c/code\u003eの共通prefix\u003ccode\u003e/foo/\u003c/code\u003eのインデックスを取得する処理です。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Split edge\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  child \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e node\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    path\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e      n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    wildChild\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    nType\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e     static\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    indices\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e   n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    children\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    handle\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e    n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    priority\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003echild\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eインデックスがノードのパスより短いとき、つまり\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e/foo/bar/baz\u003c/code\u003eのようなノードに\u003ccode\u003e/foo/bar\u003c/code\u003eを追加するようなときの処理です。\u003c/p\u003e\n\u003cp\u003e単純に現在のノードの子ノードに割り込む形で登録しています。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Make new node a child of this node\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  path \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewildChild \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    n \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// Check if the wildcard matches\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// Adding a child to a catchAll is not possible\u003c/span\u003e\n      n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e catchAll \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// Check for longer wildcard, e.g. :name and :names\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// Wildcard conflict\u003c/span\u003e\n      pathSeg \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\n      \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e catchAll \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        pathSeg \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e strings\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSplitN\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epathSeg\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      prefix \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003estrings\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIndex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e pathSeg\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\n      \u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e pathSeg \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n        \u003cspan class=\"token string\"\u003e\"' in new path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n        \u003cspan class=\"token string\"\u003e\"' conflicts with existing wildcard '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n        \u003cspan class=\"token string\"\u003e\"' in existing prefix '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e prefix \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\n        \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e今度は逆で\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e/foo/bar\u003c/code\u003eのようなノードに\u003ccode\u003e/foo/bar/baz\u003c/code\u003eを追加するようなときの処理です。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eif n.wildChild { ... }\u003c/code\u003e でワイルドカードのチェックをしています。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003eidxc \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// '/' after param\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e param \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  n \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Check if a child with the next path byte exists\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erange\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token function\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e idxc \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    n \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Otherwise insert it\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'*'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eidxc\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  child \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e child\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  n \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einsertChild\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e fullPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// '/' after param\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003enType \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e param \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  n \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epriority\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eパラメータの直後だった場合は、現在ノードの子ノードを現在ノードとして、再度ループを回します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Check if a child with the next path byte exists\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003erange\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token function\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e c \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e idxc \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    n \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e walk\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e子ノードにパスの最初の文字と同じ文字を持つ子が存在するかどうかのチェックしています。\u003c/p\u003e\n\u003cp\u003e同じ場合は、その子ノードを現在のノードとして再度無限ループに戻ります\u003c/p\u003e\n\u003cp\u003eなぜ\u003ccode\u003en.indices\u003c/code\u003eループしているかというと\u003c/p\u003e\n\u003cp\u003e直後で子要素が複数ある場合はそれらを結合して保存しているためです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// Otherwise insert it\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e':'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e idxc \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'*'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// []byte for proper unicode char conversion, see #65\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token function\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003eidxc\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  child \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u003c/span\u003enode\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eappend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003echildren\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e child\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eincrementChildPrio\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003en\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eindices\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  n \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e child\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\n\u003cspan class=\"token comment\"\u003e// Otherwise add handle to current node\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003epanic\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"a handle is already registered for path '\"\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e fullPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"'\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ehandle \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e handle\n\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e上記に該当しなければ、現在のノードに子ノードを追加し、\u003ccode\u003eHandle\u003c/code\u003eをノードに登録して終了です。\u003c/p\u003e\n\u003cp\u003eどうやって階層構造を作っているのかが全て理解できました！\u003c/p\u003e\n\u003cp\u003eでは最後に\u003ccode\u003eHandle\u003c/code\u003eとパスの階層構造をもつ\u003ccode\u003e*Router\u003c/code\u003eを呼び出すかを確認していきます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eRouter\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eResponseWriter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRequest\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePanicHandler \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003edefer\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erecv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\tpath \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eURL\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePath\n\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e root \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ereq\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethod\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e root \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ps\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e tsr \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e root\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetValue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egetParams\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e handle \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e ps \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eps\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eputParams\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eps\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethod \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodConnect \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e path \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token comment\"\u003e// Moved Permanently, request with GET method\u003c/span\u003e\n\t\t\tcode \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eStatusMovedPermanently\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethod \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodGet \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token comment\"\u003e// Permanent Redirect, request with same method\u003c/span\u003e\n\t\t\t\tcode \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eStatusPermanentRedirect\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e tsr \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRedirectTrailingSlash \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'/'\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\treq\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eURL\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\u003cspan class=\"token function\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\treq\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eURL\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eRedirect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eURL\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e code\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\t\t\u003cspan class=\"token comment\"\u003e// Try to fix the request path\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRedirectFixedPath \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tfixedPath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e found \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e root\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindCaseInsensitivePath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token function\"\u003eCleanPath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRedirectTrailingSlash\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e found \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\t\treq\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eURL\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e fixedPath\n\t\t\t\t\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eRedirect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eURL\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e code\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethod \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodOptions \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHandleOPTIONS \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// Handle OPTIONS requests\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e allow \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eallowed\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodOptions\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e allow \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tw\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e allow\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGlobalOPTIONS \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGlobalOPTIONS\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHandleMethodNotAllowed \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// Handle 405\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e allow \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eallowed\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethod\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e allow \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\"\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\tw\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Allow\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e allow\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodNotAllowed \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodNotAllowed\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eStatusText\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eStatusMethodNotAllowed\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eStatusMethodNotAllowed\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\t\t\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// Handle 404\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eNotFound \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eNotFound\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eNotFound\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこっちはかなり読みやすいです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePanicHandler \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003edefer\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erecv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\npath \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eURL\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePath\n\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e root \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ereq\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethod\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e root \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethod \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethodOptions \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHandleOPTIONS \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHandleMethodNotAllowed \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Handle 404\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eNotFound \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eNotFound\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eServeHTTP\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eNotFound\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eリクエストで受け取った\u003ccode\u003eHTTPメソッド\u003c/code\u003eが登録されておらず、\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eOPTIONS\u003c/code\u003eでも\u003ccode\u003eOPTIONS\u003c/code\u003e設定が有効出ない場合は、\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e404\u003c/code\u003eを返却します。\u003c/p\u003e\n\u003cp\u003eでは下記を見ていきます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e root \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etrees\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ereq\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMethod\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e root \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e handle\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e ps\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e tsr \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e root\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetValue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003egetParams\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e handle \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e ps \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003eps\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n      r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eputParams\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eps\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e req\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003e*node.getValue\u003c/code\u003eにすべて詰まっているようです。\u003c/p\u003e\n\u003cp\u003e今回はここまでにして、次回\u003ccode\u003e*node.getValue\u003c/code\u003eを見ます。\u003c/p\u003e\n\u003cp\u003e次回でラストにしよう。\u003c/p\u003e\n\u003ch1\u003eConclusion\u003c/h1\u003e\n\u003cp\u003eノードと子ノードの階層を作っている\u003ccode\u003e*node.addRoute\u003c/code\u003eを見てきました。\u003c/p\u003e\n\u003cp\u003e正直、自分でかんたんなものを作ってみないと完全には理解できないような気がします。\u003c/p\u003e\n\u003cp\u003e次回で絶対に終わらせたい！最初の方に扱う題材としては良かったのかなあ。\u003c/p\u003e\n\u003cp\u003e以上です。\u003c/p\u003e\n","title":"httprouter3","date":"2021-01-25","description":"3回目！httprouterです。","serialization":["httprouter","httprouter2","httprouter3"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"httprouter3"},"buildId":"fHOm68nuVOVSOHJNL3q8N","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-86038f8325ecf14c2308.js"></script><script src="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-e13f5e753692f9663f23.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.73361561705e18283b5e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-a1b5a40e975a4b990753.js" async=""></script><script src="/_next/static/fHOm68nuVOVSOHJNL3q8N/_buildManifest.js" async=""></script><script src="/_next/static/fHOm68nuVOVSOHJNL3q8N/_ssgManifest.js" async=""></script></body></html>