<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Go - テストデータの巻き戻し - The Coding Dead</title><link rel="icon" href="/favicon.ico"/><meta name="description" content="Goにおいて変更されたテストデータを終了後に戻したいとき、ありますよね?"/><meta property="og:image" content="https://raw.githubusercontent.com/the-coding-dead/the-coding-dead.github.io/main/public/images/og-image.png"/><meta name="og:title" content="Go - テストデータの巻き戻し - The Coding Dead"/><meta name="og:description" content="Goにおいて変更されたテストデータを終了後に戻したいとき、ありますよね?"/><meta name="twitter:card" content="summary"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/b9772c72096ad1651865.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b9772c72096ad1651865.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-e13f5e753692f9663f23.js" as="script"/><link rel="preload" href="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.73361561705e18283b5e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-a1b5a40e975a4b990753.js" as="script"/></head><body><div id="__next"><div class="bg-gray-800 h-auto w-screen p-3"><div class="cursor-pointer hover:opacity-75"><div><p class="text-3xl font-bold mb-2">The Coding Dead</p><p class="text-xs">窒息するほどコードを読んで<br/>スーパーエンジニアになった気になる</p></div></div></div><div class="container mx-auto"><div class="container h-screen flex flex-col"><div class="container px-2 flex-grow "><main><article class="relative container mt-5 p-3 bg-gray-600 rounded"><div class="absolute top-2 right-2 bg-gray-700 h-4 w-4 rounded-full"></div><h1 class="text-3xl mb-1">Go - テストデータの巻き戻し</h1><time dateTime="2021-03-31">March 31, 2021</time><pre class="my-0 p-0" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e;padding:1em;margin:.5em 0;overflow:auto"><code class="language-go" style="font-family:Consolas, Menlo, Monaco, &quot;Andale Mono WT&quot;, &quot;Andale Mono&quot;, &quot;Lucida Console&quot;, &quot;Lucida Sans Typewriter&quot;, &quot;DejaVu Sans Mono&quot;, &quot;Bitstream Vera Sans Mono&quot;, &quot;Liberation Mono&quot;, &quot;Nimbus Mono L&quot;, &quot;Courier New&quot;, Courier, monospace;font-size:14px;line-height:1.375;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;background:#1d262f;color:#57718e"><span class="token" style="color:#47ebb4">func</span><span> </span><span class="token" style="color:#57718e">DeferRollbackDir</span><span class="token" style="color:#4a5f78">(</span><span>t </span><span class="token" style="color:#0aa370">*</span><span>testing</span><span class="token" style="color:#4a5f78">.</span><span>T</span><span class="token" style="color:#4a5f78">,</span><span> srcDir </span><span class="token builtin">string</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span>
</span><span>	t</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">Helper</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#4a5f78">)</span><span>
</span>
<span>	memo </span><span class="token" style="color:#0aa370">:=</span><span> </span><span class="token" style="color:#57718e">setup</span><span class="token" style="color:#4a5f78">(</span><span>t</span><span class="token" style="color:#4a5f78">,</span><span> srcDir</span><span class="token" style="color:#4a5f78">)</span><span>
</span>
<span>	t</span><span class="token" style="color:#4a5f78">.</span><span class="token" style="color:#57718e">Cleanup</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#47ebb4">func</span><span class="token" style="color:#4a5f78">(</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">{</span><span> </span><span class="token" style="color:#57718e">teardown</span><span class="token" style="color:#4a5f78">(</span><span>t</span><span class="token" style="color:#4a5f78">,</span><span> memo</span><span class="token" style="color:#4a5f78">)</span><span> </span><span class="token" style="color:#4a5f78">}</span><span class="token" style="color:#4a5f78">)</span><span>
</span><span></span><span class="token" style="color:#4a5f78">}</span><span>
</span>
</code></pre><div><p>秒殺でブログやめてたのですが、いかんと思い、書きます。</p>
<p>Goでテスト書いているときに(というかどんな言語でも)</p>
<p>テスト中に変更されたテストデータをテスト終了後に戻したいときありませんか?</p>
<ul>
<li>テキストファイルに追記されていることを確認するテストで、テスト終了後にもとのテキストファイルにもどしてほしい！</li>
<li>画像がマスキングされることを確認するテストで、テスト終了後にもとの画像にもどしてほしい！</li>
<li>テストデータをGit管理していると差分が出るのでもどしてほしい!</li>
</ul>
<p>あるよね(たまにね)</p>
<h1>Sample Code</h1>
<p><a href="https://github.com/the-coding-dead/code/blob/main/testutils/defer_rollback_dir.go">DeferRollbackDir</a></p>
<h1>How To Use</h1>
<p>こんなふうにテスト対象を実行する前にディレクトリを登録しておくと</p>
<p>テスト終了後にディレクトリをもとに戻してくれます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TestHoge</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  testutils<span class="token punctuation">.</span><span class="token function">DeferRollbackDir</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"testdata/hoge"</span><span class="token punctuation">)</span>

  <span class="token function">ChangeHoge</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>これを作るために<a href="https://golang.org/pkg/os">os</a>パッケージ周りを再復習しました。</p>
<h2><a href="https://golang.org/pkg/os/#Open">os.Open</a></h2>
<p>これは読み込むためにしか利用できません。</p>
<p>実装上は<a href="https://golang.org/pkg/os/#OpenFile">os.OpenFile</a>を読み込み専用で開いています。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Open</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>File<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">OpenFile</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2><a href="https://golang.org/pkg/os/#Create">os.Create</a></h2>
<p>これは作成時用です。</p>
<p>存在している場合はtruncateします。</p>
<p>ディレクトリ内のファイルの退避として<a href="https://golang.org/pkg/os/#Create">os.Create</a>を使用します。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Create</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>File<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">OpenFile</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> O_RDWR<span class="token operator">|</span>O_CREATE<span class="token operator">|</span>O_TRUNC<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2><a href="https://golang.org/pkg/os/#RemoveAll">os.RemoveAll</a></h2>
<p>ディレクトリまたはファイルを削除できます。</p>
<p><a href="https://golang.org/pkg/os/#Remove">os.Remove</a>は空のディレクトリかファイルにしか使用できません。</p>
<p><a href="https://golang.org/pkg/os/#RemoveAll">os.RemoveAll</a>はディレクトリにファイルがある場合も削除可能です。</p>
<p><a href="https://github.com/the-coding-dead/code/blob/main/testutils/defer_rollback_dir.go">DeferRollbackDir</a>はディレクトリ復元する前に、対象のディレクトリを削除することにしました。</p>
<h2><a href="https://golang.org/pkg/os/#Mkdir">os.Mkdir</a></h2>
<p>ディレクトリを作成します。</p>
<p>親のディレクトリがない場合はエラーが起きます。</p>
<p><a href="https://github.com/the-coding-dead/code/blob/main/testutils/defer_rollback_dir.go">DeferRollbackDir</a>はそれぞれのディレクトリごとにPermissionを設定したいので(無意味か?)これを使うことにしました。</p>
<h2><a href="https://golang.org/pkg/os/#Stat">os.Stat</a></h2>
<p>この関数は対象のファイルまたはディレクトリが存在しないときに<a href="https://golang.org/pkg/os/#pkg-variables">os.ErrNotExist</a>を返却します。</p>
<p>こんな感じで<a href="https://golang.org/pkg/os/#Mkdir">os.Mkdir</a>と組み合わせます。</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ErrNotExist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2><a href="https://golang.org/pkg/os/#OpenFile">os.OpenFile</a></h2>
<p><a href="https://github.com/the-coding-dead/code/blob/main/testutils/defer_rollback_dir.go">DeferRollbackDir</a>はファイル復元時に、もとのPermissionで復元したいのでPermissionを指定できる<a href="https://golang.org/pkg/os/#OpenFile">os.OpenFile</a>でファイルを作成します。</p>
<h2>Conclusion</h2>
<p>大したことやっていないのですが、結構作るの時間かかりました。</p>
<p>これくらいの関数をまとめてテスト用のパッケージにしてくれてたりしないですかね?</p>
<p>作ってみようかな?</p>
<p>あと、<a href="https://golang.org/pkg/testing/#T.Cleanup">(*T).Cleanup</a>が便利すぎますね</p>
<p>以上です。</p>
</div></article></main></div><footer class="container mx-auto pb-5 text-center">©<!-- --> <a href="https://github.com/the-coding-dead">github.com/the-coding-dead</a></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"rollback-test-file","code":"func DeferRollbackDir(t *testing.T, srcDir string) {\n\tt.Helper()\n\n\tmemo := setup(t, srcDir)\n\n\tt.Cleanup(func() { teardown(t, memo) })\n}\n","language":"go","contentHtml":"\u003cp\u003e秒殺でブログやめてたのですが、いかんと思い、書きます。\u003c/p\u003e\n\u003cp\u003eGoでテスト書いているときに(というかどんな言語でも)\u003c/p\u003e\n\u003cp\u003eテスト中に変更されたテストデータをテスト終了後に戻したいときありませんか?\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eテキストファイルに追記されていることを確認するテストで、テスト終了後にもとのテキストファイルにもどしてほしい！\u003c/li\u003e\n\u003cli\u003e画像がマスキングされることを確認するテストで、テスト終了後にもとの画像にもどしてほしい！\u003c/li\u003e\n\u003cli\u003eテストデータをGit管理していると差分が出るのでもどしてほしい!\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eあるよね(たまにね)\u003c/p\u003e\n\u003ch1\u003eSample Code\u003c/h1\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/the-coding-dead/code/blob/main/testutils/defer_rollback_dir.go\"\u003eDeferRollbackDir\u003c/a\u003e\u003c/p\u003e\n\u003ch1\u003eHow To Use\u003c/h1\u003e\n\u003cp\u003eこんなふうにテスト対象を実行する前にディレクトリを登録しておくと\u003c/p\u003e\n\u003cp\u003eテスト終了後にディレクトリをもとに戻してくれます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003eTestHoge\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et \u003cspan class=\"token operator\"\u003e*\u003c/span\u003etesting\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eT\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  testutils\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDeferRollbackDir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003et\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"testdata/hoge\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n  \u003cspan class=\"token function\"\u003eChangeHoge\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eこれを作るために\u003ca href=\"https://golang.org/pkg/os\"\u003eos\u003c/a\u003eパッケージ周りを再復習しました。\u003c/p\u003e\n\u003ch2\u003e\u003ca href=\"https://golang.org/pkg/os/#Open\"\u003eos.Open\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eこれは読み込むためにしか利用できません。\u003c/p\u003e\n\u003cp\u003e実装上は\u003ca href=\"https://golang.org/pkg/os/#OpenFile\"\u003eos.OpenFile\u003c/a\u003eを読み込み専用で開いています。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003eOpen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ename \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003eFile\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eerror\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eOpenFile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e O_RDONLY\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003e\u003ca href=\"https://golang.org/pkg/os/#Create\"\u003eos.Create\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eこれは作成時用です。\u003c/p\u003e\n\u003cp\u003e存在している場合はtruncateします。\u003c/p\u003e\n\u003cp\u003eディレクトリ内のファイルの退避として\u003ca href=\"https://golang.org/pkg/os/#Create\"\u003eos.Create\u003c/a\u003eを使用します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003eCreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ename \u003cspan class=\"token builtin\"\u003estring\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003eFile\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eerror\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003eOpenFile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e O_RDWR\u003cspan class=\"token operator\"\u003e|\u003c/span\u003eO_CREATE\u003cspan class=\"token operator\"\u003e|\u003c/span\u003eO_TRUNC\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0666\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003e\u003ca href=\"https://golang.org/pkg/os/#RemoveAll\"\u003eos.RemoveAll\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eディレクトリまたはファイルを削除できます。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://golang.org/pkg/os/#Remove\"\u003eos.Remove\u003c/a\u003eは空のディレクトリかファイルにしか使用できません。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://golang.org/pkg/os/#RemoveAll\"\u003eos.RemoveAll\u003c/a\u003eはディレクトリにファイルがある場合も削除可能です。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/the-coding-dead/code/blob/main/testutils/defer_rollback_dir.go\"\u003eDeferRollbackDir\u003c/a\u003eはディレクトリ復元する前に、対象のディレクトリを削除することにしました。\u003c/p\u003e\n\u003ch2\u003e\u003ca href=\"https://golang.org/pkg/os/#Mkdir\"\u003eos.Mkdir\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eディレクトリを作成します。\u003c/p\u003e\n\u003cp\u003e親のディレクトリがない場合はエラーが起きます。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/the-coding-dead/code/blob/main/testutils/defer_rollback_dir.go\"\u003eDeferRollbackDir\u003c/a\u003eはそれぞれのディレクトリごとにPermissionを設定したいので(無意味か?)これを使うことにしました。\u003c/p\u003e\n\u003ch2\u003e\u003ca href=\"https://golang.org/pkg/os/#Stat\"\u003eos.Stat\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eこの関数は対象のファイルまたはディレクトリが存在しないときに\u003ca href=\"https://golang.org/pkg/os/#pkg-variables\"\u003eos.ErrNotExist\u003c/a\u003eを返却します。\u003c/p\u003e\n\u003cp\u003eこんな感じで\u003ca href=\"https://golang.org/pkg/os/#Mkdir\"\u003eos.Mkdir\u003c/a\u003eと組み合わせます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token boolean\"\u003e_\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e err \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e os\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eStat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e errors\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eIs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e os\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eErrNotExist\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e err \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e os\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eMkdir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e mode\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e err \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e err\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2\u003e\u003ca href=\"https://golang.org/pkg/os/#OpenFile\"\u003eos.OpenFile\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/the-coding-dead/code/blob/main/testutils/defer_rollback_dir.go\"\u003eDeferRollbackDir\u003c/a\u003eはファイル復元時に、もとのPermissionで復元したいのでPermissionを指定できる\u003ca href=\"https://golang.org/pkg/os/#OpenFile\"\u003eos.OpenFile\u003c/a\u003eでファイルを作成します。\u003c/p\u003e\n\u003ch2\u003eConclusion\u003c/h2\u003e\n\u003cp\u003e大したことやっていないのですが、結構作るの時間かかりました。\u003c/p\u003e\n\u003cp\u003eこれくらいの関数をまとめてテスト用のパッケージにしてくれてたりしないですかね?\u003c/p\u003e\n\u003cp\u003e作ってみようかな?\u003c/p\u003e\n\u003cp\u003eあと、\u003ca href=\"https://golang.org/pkg/testing/#T.Cleanup\"\u003e(*T).Cleanup\u003c/a\u003eが便利すぎますね\u003c/p\u003e\n\u003cp\u003e以上です。\u003c/p\u003e\n","title":"Go - テストデータの巻き戻し","date":"2021-03-31","description":"Goにおいて変更されたテストデータを終了後に戻したいとき、ありますよね?"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"rollback-test-file"},"buildId":"fHOm68nuVOVSOHJNL3q8N","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-86038f8325ecf14c2308.js"></script><script src="/_next/static/chunks/main-3d97d853b0c89cd7cfa4.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.492e6181467ebf2e0a6c.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-e13f5e753692f9663f23.js" async=""></script><script src="/_next/static/chunks/7989c093b81d86ddb0abfb342d5bc2e84730435d.73361561705e18283b5e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-a1b5a40e975a4b990753.js" async=""></script><script src="/_next/static/fHOm68nuVOVSOHJNL3q8N/_buildManifest.js" async=""></script><script src="/_next/static/fHOm68nuVOVSOHJNL3q8N/_ssgManifest.js" async=""></script></body></html>